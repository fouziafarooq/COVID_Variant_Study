---
title: "Vriant_Analysis"
author: "Fouzia Farooq"
date: "6/3/2022"
output: pdf_document
---
NOTE: This is FF's working copy (07/18/2022).

```{r, include=FALSE}
library(dplyr)
library(tidyr)
library(readr)
library(lubridate)
library(ggplot2)
library(RColorBrewer)
library(readxl)
library(xlsx)
library(patchwork)
library(haven)
library(meta)
library(tibble)
library(superheat)
library(stringr)
library(RColorBrewer)
#library(reshape)
# library(metafor)
# library(esc)
```

NOTES: json file was converted to csv in python (deepnote.com), then copied the code into BBtext and ran at the command line. 
Then ran the following code. 
Dates are fractions of a year after "year." We a creating a seperate dataframe into a csv that we will bring in R and use lubridate to read the date properly. 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


OPENSOURCE
```{r}
###################################################################
# NOTE: 3 files get updated every time I want new nextstrain data # 
################################################################### 
frequency <- read.csv('data/Nextstrain_opensource_frequenices_oct2022.csv')
covid_opensource <- read.csv('data/nextstrain_ncov_open_global_all-time_metadata_20221005.csv')
pivots <- read.csv('data/Nextstrain_opensource_pivotdates_oct2022.csv', header = FALSE)
# study_cases <- read_xlsx('data/variant_study_case_control_COVID_data_ff_20220524.xlsx') # case-comparison country study dates

################
# Study files # 
################
# compiled_ipd_data_old <- read_dta('data/Compiled_IPD_Data_220217.dta') # old ipd data file
# compiled_ipd_data_new <- read_dta('data/Compiled_IPD_Data_220620.dta') # updated with June 2022 data
# compiled_ipd_20221109 <- read_dta('data/Compiled_IPD_Data_221109.dta') # REOMOVE _old and _new.  This has comprehensive data now. 
compiled_ipd_20221130 <- read_dta('data/Compiled_IPD_Data_221130.dta') #Most updated.  This has Brazil (REBRACO data) and I need to remove AMHANII Pakistan for now. 
# will take all the patient IDs from the new file and then add in the missing rows that are in the old file to this file. 
# agd_wide <- read_dta('data/Compiled_AGD_WIDE_220408.dta') # Has events, country, but no dates.
agd_long <- read_dta('data/Compiled_AGD_220408.dta') # Has events, country, but no dates.
# country_id <- read.csv('data/country_id_ipd.csv') # FF created this file. This is the original file where I have study_site 38 as WHO Pakistan also. 
country_id <- read.csv('data/country_id_ipd_2.csv') # FF created this file. THIS HAS ONLY 1 PAKISTAN SITE (FROM AMHANII)
# country_id_agd <- read.csv('data/country_id_agd.csv')

#check.df <- compiled_ipd_data_new %>% select(gest_age_pcr, gestage_covid_month1)
#temp.df <- compiled_ipd_data_old %>% dplyr::filter(site_id==11)
# temp.df <- compiled_ipd_data_old %>% dplyr::filter(site_id==21) %>% dplyr::select(date_onset_or_test, covid_sympdate, covid_pos)

# New data from COVIPreg - Sites include Switzerland and France (From Favre Guillaume)
swiss_sheets_vec <- excel_sheets('data/TABLE_outcomes_switzerland.xlsx') # creates a vector.
swiss_df <- data.frame(month_year = {}, Events={},	Missing={},	Total={})
for (sheet in swiss_sheets_vec) {
  sheet_df <- read_excel('data/TABLE_outcomes_switzerland.xlsx', 
                         sheet=sheet, 
                         skip=2, 
                         col_names=c("month_year", "Events", "Missing", "Total"))
  sheet_df <- sheet_df %>% dplyr::mutate(Outcome=sub("switzerland - ", "", sheet),
                                         country="Switzerland")
  swiss_df <- rbind(swiss_df, sheet_df)
}

# France
france_sheets_vec <- excel_sheets('data/TABLE_outcomes_france.xlsx') # creates a vector.
france_df <- data.frame(month_year = {}, Events={},	Missing={},	Total={})
for (sheet in france_sheets_vec) {
  sheet_df <- read_excel('data/TABLE_outcomes_france.xlsx', 
                         sheet=sheet, 
                         skip=2, 
                         col_names=c("month_year", "Events", "Missing", "Total"))
  sheet_df <- sheet_df %>% dplyr::mutate(Outcome=sub("france - ", "", sheet),
                                         country="France")
  france_df <- rbind(france_df, sheet_df)
}
```

rbind Swiss and France Data and fix Date:
```{r}
swiss_france_df <- rbind(swiss_df, france_df)

# Fixing Month and Year. 
swiss_france_df <- swiss_france_df %>%
  dplyr::mutate(month_year = lubridate::parse_date_time(month_year, 'my'),
                date_ym = format(month_year, format= "%y-%m")) %>% 
  dplyr::select(-month_year)
```

Add 2 empty rows in the country_id df to add site num for France and Switzerland
```{r}
country_id <- country_id %>% rbind(c(16, "", "Switzerland", "Switzerland_COVIPREG", "Favre, Panchaud, 2022"))
country_id <- country_id %>% rbind(c(16, "", "France", "France_COVIPREG", "Favre, Panchaud, 2022"))
```

REMOVING AMHANII PAKISTAN FROM THE DATA:
```{r}
compiled_ipd_20221130 <- compiled_ipd_20221130 %>% dplyr::filter(site_id !=38)
```

```{r}
table(compiled_ipd_20221130$site_id)
```

*NOTE: This code is taken out mostly b/c the new most updated ipd file (20221109) has all the sites so no need to join old and new compiled files. 
```{r, include=FALSE}
site_id_new <- compiled_ipd_20221130$site_id
# compiled_ipd_data_old_2 <- compiled_ipd_data_old %>% dplyr::filter(!(site_id %in% site_id_new))
# table(compiled_ipd_data_old_2$site_id)
# class(compiled_ipd_data_new$neo_death_date3)
# compiled_ipd_data_old_2$neo_death_date3 <- as.numeric(compiled_ipd_data_old_2$neo_death_date3)
# compiled_ipd_data_old_2$neo_death_cause_77 <- as.numeric(compiled_ipd_data_old_2$neo_death_cause_77)
# compiled_ipd_data_old_2$neo_death_cause2_77 <- as.numeric(compiled_ipd_data_old_2$neo_death_cause2_77)
# compiled_ipd_data_old_2$neo_death_cause3_77 <- as.numeric(compiled_ipd_data_old_2$neo_death_cause3_77)
# table(compiled_ipd_data_old_2$neo_death_date3, useNA = "always")
# compiled_ipd_data <- full_join(compiled_ipd_data_old_2, compiled_ipd_data_new)
compiled_ipd_data <- compiled_ipd_20221130

```

Drop twin and triplet rows that are 2nd/3rd.  Keep the woman though
```{r}
table(compiled_ipd_data$twin2, useNA = "always")
compiled_ipd_data <- compiled_ipd_data %>% dplyr::filter(twin2!=1 | tripletnum==0) # currently there are no triplets but there are some twins. 
table(compiled_ipd_data$tripletnum, useNA = "always")
```

```{r}
opensource.df <- covid_opensource %>% dplyr::select(strain, date, country, clade_membership)

opensource.df2 <- left_join(frequency, covid_opensource, by="strain")

pivot_df <- data.frame(week = 0:(length(pivots$V1)-1), pivot = pivots$V1)
pivot_df <- pivot_df %>% dplyr::mutate(date = as.Date(date_decimal(pivot))) #converting the dates in decimal in nextstrain dataset to readable dates.

df <- left_join(opensource.df2, pivot_df, by="week")
```


```{r}
df2 <- df  %>% dplyr::mutate(variant = case_when(clade_membership %in% 
                                                   c("19A", "19B", "20A", "20B", "20C", "20D", "20F", "20G", "20E (EU1)") ~ "Pre_alpha",
                                                 clade_membership %in% 
                                                   c("20I (Alpha, V1)") ~ "Alpha",
                                                 clade_membership %in%
                                                   c("20H (Beta, V2)") ~ "Beta", 
                                                 clade_membership %in%
                                                   c("21B (Kappa)") ~ "Kappa", 
                                                 clade_membership %in%
                                                   c("21D (Eta)") ~ "Eta",
                                                 clade_membership %in% 
                                                   c("21E (Theta)") ~ "Theta",
                                                 clade_membership %in% 
                                                   c("20J (Gamma, V3)") ~ "Gamma",
                                                 clade_membership %in% 
                                                   c("21A (Delta)", "21I (Delta)", "21J (Delta)") ~ "Delta",
                                                 clade_membership %in% 
                                                   c("21C (Epsilon)") ~ "Epsilon",
                                                 clade_membership %in% 
                                                   c("21F (Iota)") ~ "Iota",
                                                 clade_membership %in% 
                                                   c("21G (Lambda)") ~ "Lambda",
                                                 clade_membership %in% 
                                                   c("21H (Mu)") ~ "Mu",
                                                 clade_membership %in% 
                                                   c("21K (Omicron)", "21L (Omicron)", 
                                                     "21M (Omicron)", "22A (Omicron)","22B (Omicron)", 
                                                     "22C (Omicron)", "22D (Omicron)") ~ "Omicron"))

# table(df2$clade_membership, df2$variant, useNA = "always") # These all have a general variant name now. 

```

NORMALIZE FREQ BY COUNTRY
```{r}
### NOTE: Removing Chile, China, Colombia, South Africa, India on 20221116
df3 <- df2 %>% group_by(country, week, variant) %>% summarize(freq = sum(frequency))
df4 <- df3 %>% group_by(country, week) %>% 
  dplyr::mutate(nor = (freq/sum(freq))) %>%
  dplyr::filter(country %in% c("Kenya", "Spain", "Hong Kong", "Italy",
                                "USA", "Mexico", "Switzerland", "France", "Brazil")) # List does not include DRC or Burkina Faso b/c opensource data is not available thorugh Nextstrain.  This list doesn't include all the african countries or the WHO countries. 

# Other countries: "Sweden","Canada","Uganda", United Kingdom, "Africa", "Turkey" 
###########################################################################
###***KEEP IN MIND: TURKEY DOESN'T HAVE COVID TEST OR SYMPTOM DATES***####
###*###########################################################################

```


```{r}
# This is where we are filtering the data by max date of the month? 
df5 <- left_join(df4, pivot_df, by="week")

df6 <- df5 %>% dplyr::mutate(date_ym = format(date, format= "%y-%m"))
df7 <- df6 %>% group_by(country, date_ym) %>% dplyr::mutate(max_date = max(date))
df8 <- df7 %>% dplyr::filter(date == max_date)
# sort(colnames(compiled_ipd_data))
check.df <- compiled_ipd_data %>% dplyr::select(site_id, person_id, mat_age, preterm_labor)
```


<!-- Joining RFA dates only - NO NEED TO RUN FOR RFA ONLY (may need for CC): -->
<!-- ```{r} -->
<!-- study_cases$date <- mdy(study_cases$date) -->
<!-- cases <- study_cases %>% dplyr::mutate(date_ym = format(date,format="%y-%m")) -->
<!-- class(study_cases$date) -->

<!-- variants_cases <- left_join(df8, cases, by=c("country", "date_ym")) -->
<!-- ``` -->


************************
STARTING STUDY ANALYSIS:
************************
NOTE: The reason some of the RFA studies show up on covid_variant_country_20220717.pdf is b/c they have aggregate data but not ipd data.  on the 20220718 file, those have been removed (like the UK and Canada).  I am just plotting data from complied_ipd_data_old and compiled_ipd_data_new.  
*File with IPD_vars.xlsx saved in folder on the computer*
```{r}
country_id$site_id <- as.numeric(country_id$site_id)
df9 <- left_join(compiled_ipd_data, country_id, by="site_id")
df10 <- df9 %>% dplyr::filter(site_id %in% c(1:13, 15:21,2201,2202,23:38)) %>% # Removed #14 (Africa for now 20220919)
  # Added 20, 24, 34, 37 and updated 5,17,10,19
  dplyr::select(site_id, city, country, site_name, author_year, person_id, twin, triplet, twin2, tripletnum, 
                mat_age, matage_cat, matage19, matage2024,matage2529,matage3034, 
                matage3539, matage40, matagem, matage1519, matage4045,matage35_older,
                gestage_covid_tri1, gestage_covid_tri2, gestage_covid_tri3, gestage_covid_postp, gestage_covid_trim,
                date_onset_or_test, covid_sympdate, 
                covid_pos, fetuses, parity, gravidity, weight_pre, # maternal outcomes: 
                prdeath1, prdeath0, prdeathm,
                covid_hosp1, covid_hosp0, covid_hospm,
                ICUadmit1, ICUadmit0, ICUadmitm,
                critcare1,critcare0, critcarem, 
                ventilation1, ventilation0,ventilationm, 
                pneumonia1, pneumonia0, pneumoniam,
                prdeath1, prdeath0, prdeathm, 
                place_abrupt1, place_abrupt0,place_abruptm, 
                preterm_labor1, preterm_labor0, preterm_laborm,
                haemorrhage1, haemorrhage0, haemorrhagem, 
                embolicdz1, embolicdz0, embolicdzm,
                preeclampsia1, preeclampsia0, preeclampsiam, 
                eclampsia1, eclampsia0, eclampsiam, 
                pre_or_eclampsia1, pre_or_eclampsia0, pre_or_eclampsiam, 
                hpd_any1, hpd_any0, hpd_anym, 
                hpd_postcovid1, hpd_postcovid0, hpd_postcovidm, 
                c_section1, c_section0, c_sectionm, 
                c_intrap1, c_intrap0, c_intrapm,
                
                # fetal outcomes: 
                stillbirth_site1, stillbirth_site0, stillbirth_sitem,
                stillbirth_281, stillbirth_280, stillbirth_28m,
                perinatal_death281, perinatal_death280, perinatal_death28m,
                perinatal_deathsite1, perinatal_deathsite0, perinatal_deathsitem, 
                nicu1, nicu0, nicum, 
                sga1, sga0, sgam, 
                extremesga1, extremesga0, extremesgam,
                lowbirthweight1, lowbirthweight0, lowbirthweightm,
                verylowbirthweight1, verylowbirthweight0, verylowbirthweightm,
                sab_site1, sab_site0, sab_sitem,
                tab_site1, tab_site0, tab_sitem,
                preterm1, preterm0, pretermm,
                verypreterm1, verypreterm0, verypretermm,
                neonatal_death1, neonatal_death0, neonatal_deathm,
                earlyneo_death1, earlyneo_death0, earlyneo_deathm,
                
                # denominators:
                denom_allpreg,denom_endpreg,denom_endpreg37,denom_totalbirth28wk,
                denom_livebirth,denom_livebirth34, denom_livebirth37) 

##############################
# WHICH DENOMINATORS TO USE #
# This info comes from Erin's .do file: 3b_PMA_R2_Output_Table_Simple_v6_triplets.do
#############################
# Maternal outcomes:
# deonminator: "denom_allpreg"
### ICU admit critcare ventilation pneumonia

# denom: "denom_endpreg" - mortality outcomes
#### prdeath matdeath matdeath_cause_covid 

# denom: denom_endpreg - morbidity outcomes/pregnancy outcomes (pregnancy infections)
### place_abrupt prom haemorrhage embolicdz hpd_any hpd_postcovid preeclampsia pre_or_eclampsia eclampsia preterm_labor --> 

# denom: denom_endpreg37 - pregnancy infections
### preterm_labor2.

# denom_totalbirth28wk - pregnancy infections
### c_section c_intrap

# denom_endpreg - cause of maternal death - mortality outcomes 2 
### matdeath_cause_coincidental maternaldeath_hem maternaldeath_hyper maternaldeath_infection maternaldeath_other maternaldeath_indirect


############################
# Neonatal/Infant Outcomes:
############################
# denom_totalbirth28wk - pregnancy infections 
### global outcomes3 = "stillbirth_28 perinatal_death28"

# denom_livebirth - pregnancy infections
### global outcomes3a = "earlyneo_death neonatal_death verypreterm preterm extremesga sga verylowbirthweight lowbirthweight veryshortga shortga nicu"

# denom_livebirth34 - pregnancy infections
### global outcomes3b = "verypreterm2"

# denom_livebirth37 - pregnancy infections
### global outcomes3c = "preterm2"





# use date_onset_or_test --> If tested for covid, it is date of first positive test. 

### Maternal outcomes: 
# covid_hosp1 = COVID-19 related hospitalization events
# ICUadmit1 = ICU admission events
# critcare1 = critical care events
# ventilation1 = Ventilation events
# pneumonia1 = Pneumonia events
# prdeath1 = Pregnancy-related death events
# place_abrupt1 = Maternal morbidity events - place_abrupt
# preterm_labor1 = Maternal morbidity events - preterm_labor
# haemorrhage1 = Maternal morbdity events - haemorrhage
# embolicdz1 = Maternal morbidity events - embolicdz
# preeclampsia1 = Maternal morbdity events - preeclampsia
# eclampsia1 = Maternal morbdity events - eclampsia
# pre_or_eclampsia1 = Maternal morbidity events - preeclampsia/eclampsia
# hpd_any1 = Maternal morbdity events - hpd_any
# hpd_postcovid1 = Maternal morbdity events - hpd_postcovid
# c_section1 = All C-Sections (among all stillbirths + livebirths)
# c_intrap1 = Intrapartum C-section Events (among all stillbirths + livebirths)

### Fetal outcomes: 

# stillbirth_site1 = Pregnancy endpoint is stillbirth (as defined by site)
# stillbirth_281 = Stillbirths at/after 28 weeks events
# sab_site1 = Pregnancy endpoint is SAB (defined by site)
# tab_site1 = Pregnancy endpoint is TAB (defined by site)
# lowbirthweight1 = Low birthweight events (<2500 grams)
# verylowbirthweight1 = Very low birthweight events (<1500 grams)
# verypreterm1 = Moderate/very preterm events (<34 weeks GA at birth)
# preterm1 = Preterm events (<37 weeks GA at birth)
# neonatal_death1 = Neonatal death events (<28 days)
# earlyneo_death1 = Early neonatal death events (<7 days)
# perinatal_death281 = Perinatal death events (deaths <7 days & SB at 28w)
# perinatal_deathsite1 = Perinatal death events (deaths <7 days & SB defined by site)
# nicu1 = NICU admission at birth - events
# sga1 = SGA events (<10th percentile)
# extremesga1 = Extreme sga events (<3rd percentile)
```

Summary for Table 1:
```{r}
mat_age_df <- df10 %>% group_by(city, country) %>%
  summarize(mean_age  = mean(mat_age), 
            sd_age = sd(mat_age),
            tot_preg = sum(denom_allpreg),
            livebirths = sum(denom_livebirth),
            ga_tri1 = round((sum(gestage_covid_tri1)/tot_preg)*100, 0),
            ga_tri2 = round((sum(gestage_covid_tri2)/tot_preg)*100, 0),
            ga_tri3 = round((sum(gestage_covid_tri3)/tot_preg)*100, 0),
            ga_pp = round((sum(gestage_covid_postp)/tot_preg)*100, 0),
            ga_unknown = round((sum(gestage_covid_trim)/tot_preg)*100, 0),
            hospitalized = round(sum(covid_hosp1)/tot_preg*100, 0),
            icu_admit = round(sum(ICUadmit1)/tot_preg*100, 0),
            twins = sum(twin2),
            triplets = sum(tripletnum))
```

Creating maternal and fetal composite outcomes:
```{r}
# NOTE: THIS COMPOSITE OUTCOME CAN'T BE DONE ON AGGREGATE DATA (SWISS FRANCE) B/C EXAMPLE: ICU ADMISSION EVENTS =3, CRITICAL CARE EVENTS = 3, WE DON'T KNOW IF THOSE TWO OUTCOMES HAPPENED TO THE SAME 3 WOMEN OR 6 DIFFERENT WOMEN. 

# WILL MAKE A NOTE NEXT TO THESE VARIABLES STATING IT DOENS'T INCLUDE SWISS/FRANCE.

# NOTE: I had these vars in maternal_composite_outcome as well before: 
# covid_hosp1==1 | ICUadmit1==1 | covid_icu==1 | critcare1==1| ventilation1==1 | pneumonia1==1 | prdeath1==1 | 

df10 <- df10 %>% 
  dplyr::mutate(mat_composite_outcome = if_else((place_abrupt1==1 |
                                          preterm_labor1==1 | haemorrhage1==1 | embolicdz1==1 | 
                                          preeclampsia1==1 | eclampsia1==1 | pre_or_eclampsia1==1 | 
                                          hpd_any1==1 | hpd_postcovid1==1 | c_section1==1 | c_intrap1==1), 1, 0))


str(df10$covid_hosp1)
df10 <- df10 %>% 
  dplyr::mutate(fetal_composite_outcome = if_else((stillbirth_site1==1 | stillbirth_281==1 | lowbirthweight1==1 |
                                                   verylowbirthweight1==1 |sab_site1==1 | tab_site1==1 | preterm1==1 |
                                                   verypreterm1==1 | neonatal_death1==1 |earlyneo_death1==1  | 
                                                   perinatal_death281==1 | perinatal_deathsite1==1 | nicu1==1 | 
                                                   sga1==1 | extremesga1==1), 1, 0))

table(df10$fetal_composite_outcome)
```


Date format:
```{r}
df10 <- df10 %>% dplyr::mutate(date_ym = format(date_onset_or_test,format="%y-%m"))
unique(df10$country)
unique(compiled_ipd_data$site_id)
unique(df10$site_name)

df10.1 <- df10 %>% filter(!is.na(date_onset_or_test))
```

```{r}
## CREATEING A NEW FILE SO I CAN OVERLAY ON GRAPHS AGAIN TO SEE  IF WE HAVE  MORE THAN 1 VRIANT DATA WITH THIS UPDATED FILE FROM ERIN OR NOT.
# check.df <- compiled_ipd_data_old %>% dplyr::select(site_id)
min(df10.1$date_onset_or_test, na.rm=TRUE)
df10.2 <- df10.1 %>% dplyr::select(site_id, city, country, site_name, author_year, date_onset_or_test, date_ym) 
# check.df <- compiled_ipd_data_old %>% dplyr::filter(site_id=="1")
df10.2 <- df10.2 %>% dplyr::mutate(date_onset_or_test = format(date_onset_or_test,format="%m-%d-%y"))
df10.3 <- df10.2 %>% group_by(country) %>% arrange(country, date_ym)
df10.4 <- df10.3 %>% group_by(country, author_year, date_ym) %>% tally()
df10.4 <- df10.4 %>% rename(Events='n') %>% mutate(study_type = "RFA",
                                                   study_type_full = "Risk Factor Analysis")
df10.4 <- df10.4 %>% dplyr::filter(!is.na(date_ym))
df10.4 <- df10.4 %>% mutate(date = as.Date(paste0("20", date_ym, "-01")))
df10.5 <- df10.4 %>% mutate(pandemic_month = interval("2019-12-01", date) %/% months(1))

# df10.5$date <- format(df10.5$date, format="%y-%m-%d")
df10.6 <- df10.5 %>% dplyr::select(-date_ym)

# write.csv(df10.5, 'data/variant_newdata_dates_ipd_ff_20220627.csv', row.names = FALSE) # writing this file out so I can overlay on the graphs from nextstrain data
# study_cases_2 <- study_cases %>% dplyr::select(-study_period)   
study_cases_2 <- df10.6
# df10.7 <- rbind(study_cases_2, df10.6)
df10.8 <- df10.6 %>% arrange(country, study_type, date)
```

***TRYING TO ADD IN SWISS/FRANCE DATA HERE***
```{r}
sf_df<- swiss_france_df %>% rename(outcome=Outcome, events1=Events,
                                                                 eventsm=Missing)
```

ADD IN -01 TO THE DATE.
```{r}
sf_df <- sf_df %>% dplyr::filter(!is.na(date_ym))
sf_df <- sf_df %>% mutate(date = as.Date(paste0("20", date_ym, "-01")))
# sf_df <- sf_df %>% mutate(site_name = country)
sf_fig_df <- sf_df %>% group_by(country, date) %>% 
  summarize(Events = sum(events1))
sf_fig_df <- sf_fig_df %>% mutate(author_year = "Favre, Panchaud, 2022",
                                  study_type = "RFA",
                                  study_type_full = "Risk Factor Analysis")
sf_fig_df <- sf_fig_df %>% mutate(pandemic_month = interval("2019-12-01", date) %/% months(1))
```

MERGE THE TWO DATASETS HERE for line on Nextstrain variant figure:
```{r}
df10.8_sf_df <- rbind(df10.8, sf_fig_df)
```

New map with overlaid CC study dates and RFA study dates: 06/27/2022 - latest
```{r}
studies_df <- df10.8_sf_df %>% dplyr::filter(Events>=1) %>% 
  group_by(country, author_year, study_type) %>%
  summarize(min_month = min(pandemic_month),
            max_month = max(pandemic_month)) %>%
  group_by(country) %>%
  mutate(country_study_number = 1:n(),
         country_total_studies = n())
# see https://stackoverflow.com/questions/36893957/dplyr-generate-row-number-row-position-in-group-by

gap_betw_studies <- 0.15

temp.df <- df8 %>% dplyr::filter(country=="Turkey")
temp.df <- df10.6 %>% dplyr::filter(country=="Turkey")
ggplot() +
  geom_bar(data = df8, stat="identity",
           mapping = aes(x = date_ym, fill = variant, y=nor)) +
  scale_fill_manual(values = c("Alpha" = "deepskyblue2", "Pre_alpha" = "lightsteelblue1", "Beta" = "darkseagreen1",
                               "Delta" = "gold", "Epsilon" = "burlywood", "Eta" = "cadetblue2", "Gamma" = "darkgoldenrod1",
                               "Iota" = "cyan3", "Lambda" = "gray70", "Mu" = "peachpuff1", "Omicron" = "plum2",
                               "Theta" = "tomato")) + 
  theme_light() + 
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust=1, size = 6),
        axis.text.y = element_text(size = 6)) + 
  xlab("Year-Month") + 
  ylab("Relative Frequency") +
  geom_rect(data = studies_df,
            mapping=aes(xmin=min_month-0.5,
                        xmax=max_month+0.5,
                        ymin= 0.5 - 0.5*gap_betw_studies*(country_total_studies-1) + gap_betw_studies*(country_study_number - 1) - 0.005,
                        ymax= 0.5 - 0.5*gap_betw_studies*(country_total_studies-1) + gap_betw_studies*(country_study_number - 1) + 0.005)) +
  geom_text(data = studies_df,
            mapping=aes(x = 0.5*(min_month + max_month),
                        y = 0.5 - 0.5*gap_betw_studies*(country_total_studies-1) + gap_betw_studies*(country_study_number - 1) + 0.05,
                        label = author_year),
                     #   label = ifelse(is.na(site_name),
                      #                 study_type,
                       #                paste(site_name, study_type))),
            size = 2) +
  guides(fill = guide_legend(override.aes = list(labels = c("A", "B")))) +
  facet_wrap(~country, nrow = 30, ncol = 1, scale = "free_x")

today_date <- format(Sys.time(), "%Y%m%d")
ggsave(filename = paste0('plots/variants_nextstrain/covid_variant_country_',today_date, '.pdf'), width = 6, height = 20, units = "in") #This includes Colombia data (which was excluded b/c i had it spelled ColUmbia before)
# DON'T NEED TO WRITE THIS OUT EVERYTIME.

# write.csv(df8, 'data/nextstrain_frequency_data_written_ff_20220610.csv', row.names = FALSE)
temp.df <- df8 %>% dplyr::filter(country=="USA")
```


Making frequency dataset wider and then we will join it onto compiled_ipd data
```{r}
##########################
### THRESHOLD SETTING ###
#########################
dom_threshold <- 0.50
df8.1 <- df8 %>% group_by(country, date_ym) %>%
  arrange(desc(freq)) %>% # we first ordered the frequency and the highest is on top. 
  mutate(dominant_variant = if_else(first(freq)==0,
                                    "no_strain", 
                                    # first(variant))) %>% 
                                      ifelse(!is.na(first(nor)) & first(nor)>=dom_threshold, # This is the other way of defining the dominant variant-- when it's greater than 60% then call it the dominant variant, otherwise call the set mixed. 
                                           first(variant), 
                                           "mixed"))) %>% 
  mutate(dominant_variant_v1 = if_else(first(freq)==0,
                                    "no_strain", 
                                    first(variant))) %>%
  ungroup() %>%
  arrange(country, date_ym) # first arranges the strains in descending order then pulls out the strain name for the first one b/c now it has the greatest frequency. Then we ungrouped and rearranged so we can see by country and date order. 

table(df8.1$dominant_variant_v1, df8.1$dominant_variant, useNA = "always")


df8_wide <- df8.1 %>% 
  dplyr::select(-c(freq, week, date, max_date, pivot)) %>% 
  pivot_wider(names_from = variant, values_from = nor, values_fill = 0, names_prefix = "freq_") # pivot wider and adds a prefix "freq" to the variable in "values_from".
# Pivot wider comes from tidyr.
```

Merge the frequency dataset (wide) on our study dataset (IPD dataset)
```{r}
df11 <- left_join(df10, df8_wide, by=c('country', 'date_ym'))
temp.df <- df11 %>% dplyr::filter(country=="USA")
```

Pivot longer from df11 so I have missing data also. 
```{r}
sort(colnames(df11))
df11m <- df11 %>% pivot_longer(cols=c(prdeath1, prdeath0, prdeathm,
                covid_hosp1, covid_hosp0, covid_hospm,
                ICUadmit1, ICUadmit0, ICUadmitm,
                critcare1,critcare0, critcarem, 
                ventilation1, ventilation0,ventilationm, 
                pneumonia1, pneumonia0, pneumoniam,
                prdeath1, prdeath0, prdeathm, 
                place_abrupt1, place_abrupt0,place_abruptm, 
                preterm_labor1, preterm_labor0, preterm_laborm,
                haemorrhage1, haemorrhage0, haemorrhagem, 
                embolicdz1, embolicdz0, embolicdzm,
                preeclampsia1, preeclampsia0, preeclampsiam, 
                eclampsia1, eclampsia0, eclampsiam, 
                pre_or_eclampsia1, pre_or_eclampsia0, pre_or_eclampsiam, 
                hpd_any1, hpd_any0, hpd_anym, 
                hpd_postcovid1, hpd_postcovid0, hpd_postcovidm, 
                c_section1, c_section0, c_sectionm, 
                c_intrap1, c_intrap0, c_intrapm,
                
                # fetal outcomes: 
                stillbirth_site1, stillbirth_site0, stillbirth_sitem,
                stillbirth_281, stillbirth_280, stillbirth_28m,
                perinatal_death281, perinatal_death280, perinatal_death28m,
                perinatal_deathsite1, perinatal_deathsite0, perinatal_deathsitem, 
                nicu1, nicu0, nicum, 
                sga1, sga0, sgam, 
                extremesga1, extremesga0, extremesgam,
                lowbirthweight1, lowbirthweight0, lowbirthweightm,
                verylowbirthweight1, verylowbirthweight0, verylowbirthweightm,
                sab_site1, sab_site0, sab_sitem,
                tab_site1, tab_site0, tab_sitem,
                preterm1, preterm0, pretermm,
                verypreterm1, verypreterm0, verypretermm,
                neonatal_death1, neonatal_death0, neonatal_deathm,
                earlyneo_death1, earlyneo_death0, earlyneo_deathm),
                
                # denominators:
                #denom_allpreg,denom_endpreg,denom_endpreg37,denom_totalbirth28wk,
                # denom_livebirth,denom_livebirth34, denom_livebirth37),
                              names_to = "outcome", values_to = "events")

```

Groupby and summarize with events and missing variables
```{r}

# This group_by() has date_ym in it. 
df11m.1 <- df11m %>% group_by(site_name, country, dominant_variant, dominant_variant_v1, outcome, date_ym) %>%
  summarize(events = sum(events, na.rm = FALSE))
           # tot_n = n(),
            #incidence = events/tot_n)
```

Mutate - remove the 0,1,m first and put that in a new column. 
```{r}
df11m.2 <- df11m.1 %>% mutate(outcome_mod = str_sub(outcome, -1), # from the first position all to way to second from the end.
                              outcome = str_sub(outcome, 1,-2)) # the last char.   
```

Pivot wider:
```{r}
df11m.2_wide <- df11m.2 %>% pivot_wider(names_from = outcome_mod, names_prefix = "events", values_from = events)

df11m.2_wide<- df11m.2_wide %>% mutate(Total = events0 + events1+ eventsm) # %>%
  # dplyr::select(-events0)

# Add in a total column first:

```

***ADD IN SWISS/FRANCE DATA HERE***
```{r}
sf_df4 <- left_join(sf_df, df8_wide, by=c('country', 'date_ym'))

sf_df5 <- sf_df4 %>% dplyr::select(country, outcome, date_ym, dominant_variant, dominant_variant_v1, events1, eventsm, Total)
```

Mutate - remove the 0,1,m first and put that in a new column for Aggregated data (swiss, france)
```{r}
sf_df5.1 <- sf_df5 %>% mutate(outcome_mod = str_sub(outcome, -1), # from the first position all to way to second from the end.
                              outcome = str_sub(outcome, 1,-2)) # the last char.   
```

```{r}
# sf_df3.1 <- sf_df3 %>% rename(events1 = Events, eventsm = Missing)
merged_df <- rbind(df11m.2_wide, sf_df5.1)
```


```{r}
#write.xlsx(as.data.frame(df14), file='data_out/variants_ipd_results_20220706.xlsx', sheetName="dominant_strain_country", row.names = FALSE)

merged_df2 <- merged_df %>% mutate(incidence = events1/Total)

#write.xlsx(as.data.frame(df14.1), file='data_out/variants_ipd_results_20220706.xlsx', sheetName="dominant_strain_outcome", row.names = FALSE, append=TRUE)
```

REMOVING OUTCOME IF MISSING >25% FOR EACH COUNTRY.
```{r}
missing_threshold <- 0.25

merged_df3 <- merged_df2 %>% group_by(country, outcome) %>% 
  mutate(outcome_missing = sum(eventsm),
            outcome_total = sum(Total),
            pct_missing = outcome_missing/outcome_total) %>%
  select(-outcome_missing, -outcome_total) %>% 
  filter(pct_missing < missing_threshold)
```



```{r}
# This is more useful

merged_df3 %>% 
  filter(dominant_variant!="Beta") %>% # beta numbers are very low. 
  ggplot() +
  geom_col(aes(x=dominant_variant, y=incidence, fill=outcome), 
           width = 0.65,
           position="dodge") + 
  scale_x_discrete(limits = c("no_strain", 'mixed', "Pre_alpha", "Alpha", "Beta", "Delta", "Omicron")) + 
  xlab("Dominant Strain")


# df14.1 %>% 
#   filter(dominant_variant!="Beta") %>% 
#   ggplot() +
#   geom_col(aes(x=outcome, y=incidence, fill= dominant_variant), 
#            width = 0.7, 
#            position="dodge") + 
#   theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```


Functions for continuity correction and calc logRR and SEs. 
```{r}
  ### used this link to calc: https://www.medcalc.org/manual/relative-risk-odds-ratio.php
  ### function for calculating RR (not logRR)
  rr_ff <- function(pos_test, pos_ref, neg_test, neg_ref, adj=0.5){
    useadj <- pos_test==0 | neg_test==0 | pos_ref==0 | neg_ref==0
    
    a <- pos_test+useadj*adj
    b <- neg_test+useadj*adj
    c <- pos_ref+useadj*adj
    d <- neg_ref+useadj*adj
    return((a/(a+b))/((c/(c+d))))
  }
  
  ### this calculates SE for logRR not just RR - so this is logSE
  se_logrr_ff <- function(pos_test, pos_ref, neg_test, neg_ref, adj=0.5){
    useadj <- pos_test==0 | neg_test==0 | pos_ref==0 | neg_ref==0
    a <- pos_test+useadj*adj
    b <- neg_test+useadj*adj
    c <- pos_ref+useadj*adj
    d <- neg_ref+useadj*adj
    return(sqrt((1/a)+(1/c)-(1/(a+b))-(1/(c+d))))
  }

```

Setting up for metagen - for loop:
```{r, include=FALSE}
df14.negpos.outcome <- merged_df3 %>% mutate(neg = Total - events1)
strain_vec <- unique(df14.negpos.outcome$dominant_variant) # creates a vector of all different strain names.
strain_vec <- strain_vec[!is.na(strain_vec)] # removes NAs
strain_vec <- strain_vec[strain_vec!="no_strain"]
df14.alpha <- data.frame(matrix(nrow = 0, ncol=10))

for (ref.strain in strain_vec) {
  for (test.strain in strain_vec) {
    if(ref.strain==test.strain) {
      next # skips this iteration when the two strains are the same. 
    }
    df14.alpha.rows <- df14.negpos.outcome %>% 
      dplyr::filter(dominant_variant %in% c(ref.strain, test.strain)) %>%
      group_by(site_name, dominant_variant, outcome) %>%
      #  dplyr::filter(outcome %in% c("matdeath", "preterm_labor")) %>% 
      summarise(pos = sum(events1), 
                neg = sum(neg)) %>%
      mutate(dominant_variant = if_else(dominant_variant==ref.strain,
                                        "reference",
                                        "test")) %>%
      pivot_wider(names_from = dominant_variant, values_from = c("pos", "neg")) %>%
      drop_na() %>% # drops countries that don't have one or the other dominant strain.
     mutate(ref.strain=ref.strain, test.strain=test.strain) %>%
      mutate(logRR = if_else(pos_reference==0 & pos_test==0,
                             as.numeric(NA),
                             log(rr_ff(pos_ref=pos_reference, pos_test=pos_test, neg_ref=neg_reference, neg_test=neg_test))),
             logSE = if_else(pos_reference==0 & pos_test==0,
                             as.numeric(NA),
                             se_logrr_ff(pos_ref=pos_reference, pos_test=pos_test, neg_ref=neg_reference, neg_test=neg_test)))
    
    df14.alpha <- rbind(df14.alpha, df14.alpha.rows)
    
  }
}
```

Results dataframe for heatmap
```{r}
heatmap_data_df <- data.frame(Outcome = {}, Strain = {}, Ref_Strain = {}, RR = {}, LCI = {}, UCI = {}, n_study = {})
```


*METAGEN FUNCTION*
```{r}
# FUNCTION CREATED:
metagen_fun <- function(refstr, teststr) {
  df14.strainpair <- df14.alpha %>%
    dplyr::filter(ref.strain==refstr &
                  test.strain==teststr)
  colnames(df14.strainpair)[colnames(df14.strainpair) == "pos_reference"] <- paste0(refstr, "+")
  colnames(df14.strainpair)[colnames(df14.strainpair) == "neg_reference"] <- paste0(refstr, "-")
  colnames(df14.strainpair)[colnames(df14.strainpair) == "pos_test"] <- paste0(teststr, "+")
  colnames(df14.strainpair)[colnames(df14.strainpair) == "neg_test"] <- paste0(teststr, "-")
    
  if(nrow(df14.strainpair)==0){ # when a certain pair of strains is not present, we wnat it to skip, e.g. Delta-Epsilon is missing when dominant strain defined as >=70% prevalence. 
    print("     No such strain pair found - better skip this one!")
    return()
  }
  
  ### metagen 
  mymeta <-metagen(logRR, logSE,
                   studlab=paste(site_name), data=df14.strainpair,
                   fixed= FALSE, random=TRUE,
                   subset=NULL, sm="RR",
                   method.tau="ML", # Default Restricted maximum likelihood estimator (REML) did not always converge so using ML. 
                   subgroup =df14.strainpair$outcome,
                   title="Variant")
# added in the continuity correction by hand - codded it. 
# manual process in STATA - replaced 0 with the inverse of the opposite arm. can try this code. Making the continuity correction smaller helps but not always. Pooled absolute risks and pooled relative risks that were illogical, absolute risk was high for one group but relative risk was lower for that group.   If there are 0 events for delta and alpha, what to do with that estimate. 
  # summary (mymeta)
  
  
  # PULL OUT:
# TE.random.w (Estimated effect in subgroup (random effect model))
# lower.random.w (CI for the random effects)
# upper.random.w (upper CI for the random effects)
# k.study.w has number of studies that are included for each random effects model for each outcome given a ref strain and test strain. 
# for more info: ?metagen --> then click on "meta.object".
# http://127.0.0.1:57661/help/library/meta/help/meta-object

  heatmap_data_df2 <- data.frame(Outcome=mymeta$bylevs, Strain=teststr, Ref_Strain=refstr, 
                            RR=exp(mymeta$TE.random.w), LCI=exp(mymeta$lower.random.w), UCI=exp(mymeta$upper.random.w), n_study=mymeta$k.study.w)
  
  print(heatmap_data_df2)
  #generate forest plot:HERE
  day_string <- format(Sys.time(), "%Y%m%d")
  dir_folder_name <- paste0(day_string,"_domvar_mixed_",as.character(dom_threshold*100))
  dir.create(paste0("plots/",dir_folder_name))
  pdf(file=paste0("plots/",dir_folder_name,"/VariantStudy_MetaForestPlot_teststr_", teststr, "_refstr_", refstr, ".pdf"), width=10, height=65) # pdf saving has to go before making the plot and at the end have to say dev.off()
  
  forest(mymeta, sortvar=logRR, comb.random, 
         leftcols = c("studlab", paste0(teststr, "+"), paste0(teststr, "-"), paste0(refstr, "+"),
                    paste0(refstr, "-")),
         lab.NA.effect = "NA",
         colgap.forest.left = "1mm",
         fontsize = 10, 
         fs.hetstat = 9, 
         header=TRUE, 
         overall=FALSE, 
         col.diamond = "#33CC66", 
         col.study= "#333333")
  # grid.text("Variant study by outcome", .5, .89, gp=gpar(cex=1)) # only works in R version 3.

  dev.off()
  return(heatmap_data_df2)
}
```

```{r, include=FALSE}
for (ref.strain in strain_vec) {
  for (test.strain in strain_vec) {
    if(ref.strain==test.strain) {
      next # skips this iteration when the two strains are the same. 
    }
    print(paste(ref.strain, test.strain))
    heatmap_data_df2 <- metagen_fun(ref.strain, test.strain)
    heatmap_data_df <- rbind(heatmap_data_df, heatmap_data_df2)
  }
}
```

Setting up a big table for heatmap
```{r}
heatmap_data_df2 <- heatmap_data_df %>% 
  mutate(RR_CI_lab = paste0(round(RR, 2), " (", round(LCI, 2), ", ", round(UCI,2), "), n=", n_study))

heatmap_data_df2 <- heatmap_data_df2 %>% dplyr::filter(!n_study==0)
# heatmap_df3 <- heatmap_data_df2 %>% dplyr::select(-RR, -LCI, -UCI, -n_study)
```



***Creating a new big table that has outcome col, ref strain col and test strain going across with pooled estimates.***
THIS WRANGLING IS INSANELY CLEVER!!!!
```{r}
est_table_df <- heatmap_data_df %>%
  mutate(RR_CI_lab = if_else(is.na(RR),
                             "n=0",
                             paste0(round(RR, 2), " (", round(LCI, 2), ", ", round(UCI,2), "), n=", n_study))) %>% 
  dplyr::select(-RR, -LCI, -UCI, -n_study) %>%
  pivot_wider(names_from = Strain, values_from = RR_CI_lab, names_prefix = "Strain_") %>% 
  pivot_longer(cols = starts_with("Strain_"), names_to = "Strain", values_to = "RR_CI_lab") %>%
  mutate(Strain = str_replace(Strain, "Strain_", "")) %>% 
  mutate(RR_CI_lab = if_else(Strain==Ref_Strain,
                             "Reference",
                             if_else(is.na(RR_CI_lab),
                                     "n=0",
                                     RR_CI_lab))) %>%
  pivot_wider(names_from = Strain, values_from = RR_CI_lab) # %>%
 # arrange(Outcome)
table(est_table_df$Outcome)
est_table_df2 <- est_table_df %>%
  mutate(Ref_Strain = factor(Ref_Strain, 
                         levels = c("Pre_alpha", "Alpha", "Beta", "Delta", "Epsilon", "Eta", "Omicron", "mixed"),
                         labels = c("Pre-alpha", "Alpha", "Beta", "Delta", "Epsilon", "Eta", "Omicron", "Mixed"))) %>%
  
  mutate(Outcome = factor(Outcome, 
                          levels = c("covid_hosp", "ICUadmit", "critcare", "ventilation", "pneumonia","matdeath",
                "prdeath", "place_abrupt", "preterm_labor", "haemorrhage", "embolicdz",
                "preeclampsia", "eclampsia", "pre_or_eclampsia", "hpd_any", "hpd_postcovid", "c_section",
                "c_intrap","mat_composite_outcome",
                # fetal & neonatal morbidity & mortality outcomes:
                "stillbirth_site", "stillbirth_28", "perinatal_death28", "perinatal_deathsite",
                "earlyneo_death",  "neonatal_death","nicu",
                # Adverse Birth outcomes
                "verylowbirthweight", "lowbirthweight", "extremesga", "sga", "verypreterm", "verypreterm2","preterm", "preterm2",
                "sab_site", "tab_site","fetal_composite_outcome"), 

           labels = c("Hospitalization", "ICU admission", "Critical care", "Ventilation", "Pneumonia",  "Maternal death",
                      "Preganncy-related death", "Placental abruption", "Preterm labor", "Haemorrhage", "Embolic disease",
                      "Preeclampsia", "Eclampsia", "Preeclampsia or eclampsia" , "Any HDP ",
                      "HDP during or after COVID-19", "C-section", "Intrapartum C-section", "Maternal composite outcome",
               # fetal & neonatal morbidity & mortality outcomes:
                "Stillbirth site", "Stillbirth","Perinatal death", "Perinatal death site", 
               "Early neonatal death","Neonatal death", "NICU admission", 
               # Adverse Birth Outcomes
               "vLBW", "LBW", "eSGA","SGA", "vPTB", "vPTB - COVID onset <34w", "PTB", "PTB -COVID onset <37w",   
               "SAB site", "Tab site","Fetal composite outcome"))) %>%

  arrange(Outcome, Ref_Strain) %>%
  select(Outcome, `Reference Strain` = Ref_Strain, `Pre-alpha` = Pre_alpha, Alpha, Beta, Delta, Epsilon, Eta, Omicron, Mixed = mixed)

day_string <- format(Sys.time(), "%Y%m%d")
write.csv(est_table_df2, paste0("data_out/",day_string,"_Variant_study_pooled_table.csv"), row.names = FALSE)
    
# write.csv(est_table_df, 'data_out/20221129_variant_study_pooled_table.csv', row.names = FALSE)
```

Heatmap that loops through each dataset. 
```{r}
# We want to loop through each reference strain (rs)
#TODO
# NOTE: NA label here is total of NAs --> NEED TO REMOVE
outcome_vec <- c("matdeath","covid_hosp", "ICUadmit", "critcare", "ventilation", "pneumonia",
                "prdeath", "place_abrupt", "preterm_labor", "haemorrhage", "embolicdz",
                "preeclampsia", "eclampsia", "pre_or_eclampsia", "hpd_any", "hpd_postcovid", "c_section",
                "c_intrap","mat_composite_outcome",
                # fetal outcomes: 
                "stillbirth_site", "stillbirth_28", "sab_site", "tab_site", "neonatal_death", "earlyneo_death", 
                "perinatal_death28", "perinatal_deathsite", "nicu","lowbirthweight", "verylowbirthweight",
                 "verypreterm", "verypreterm2", "preterm", "preterm2", "sga", "extremesga", "fetal_composite_outcome")


for (rs in levels(factor(heatmap_data_df2$Ref_Strain))) {
  heatmap_data <- heatmap_data_df2 %>% dplyr::filter(Ref_Strain==rs)

  # Conditional Formatting:
  heatmap_data <- heatmap_data %>% 
    mutate(RR_sig = case_when((RR>1.05 & LCI>1 & UCI>1) ~ "RR>1.05, CI-sig",
                              (RR<0.95 & LCI <1 & UCI<1) ~ "RR<0.95, CI-sig",
                              TRUE~ "NS"))
  
  heatmap_data$RR_sig <- factor(heatmap_data$RR_sig, 
                                 levels=c("RR>1.05, CI-sig", "RR<0.95, CI-sig", 
                                          "NS"),
                                ordered = TRUE)
  
heatmap_data$Outcome <- factor(heatmap_data$Outcome, 
                               levels=outcome_vec, 
                               ordered = TRUE)
  
  myColorScale <- brewer.pal(4,"Set2")
  names(myColorScale) <- levels(heatmap_data$RR_sig)
  levels(heatmap_data$RR_sig)
  
  
  colScale <- c("RR>1.05, CI-sig" = "orangered", 
                "RR<0.95, CI-sig" = "dodgerblue", 
                "NS" = "gray") 
  
  # THIS PIECE DOES NOT REMOVE N=1 STUDIES
 #  hmap <- heatmap_data %>% drop_na(Outcome) %>% # Removes NA estimates
 #    ggplot() +
 #    aes(x = Strain, y=Outcome, fill=RR_sig) +
 #    geom_tile()+
 #    scale_fill_manual(values = colScale) +
 #    geom_text(aes(label=RR_CI_lab), size=2) + 
 #    guides(fill=guide_legend((title = "RR & 95%CI")))+
 #    labs(title=paste0("Reference strain: ",rs)) + 
 #    theme(plot.title = element_text(hjust = 0.5))
 # 
 # ggsave(paste0('plots/heatmap/n>=1/variant_study_heatmap_',
 #               format(Sys.time(), "%Y-%m-%d_%H-%M"),
 #               "_refstrain", 
 #               rs,
 #               "_n_study>=1.pdf"),
 #        hmap, width = 10, height = 6, units = "in")
 
  heatmap_data2 <- heatmap_data %>%
  mutate(Strain = factor(Strain, 
                         levels = c("Pre_alpha", "Alpha", "Beta", "Delta", "Epsilon", "Eta", "Omicron", "mixed"),
                         labels = c("Pre-alpha", "Alpha", "Beta", "Delta", "Epsilon", "Eta", "Omicron", "Mixed"))) %>%
    mutate(Outcome = factor(Outcome,
           levels = c("covid_hosp", "ICUadmit", "critcare", "ventilation", "pneumonia","matdeath",
                "prdeath", "place_abrupt", "preterm_labor", "haemorrhage", "embolicdz",
                "preeclampsia", "eclampsia", "pre_or_eclampsia", "hpd_any", "hpd_postcovid", "c_section",
                "c_intrap","mat_composite_outcome",
                # fetal & neonatal morbidity & mortality outcomes:
                "stillbirth_site", "stillbirth_28", "perinatal_death28", "perinatal_deathsite",
                "earlyneo_death",  "neonatal_death","nicu",
                # Adverse Birth outcomes
                "verylowbirthweight", "lowbirthweight", "extremesga", "sga", "verypreterm", "verypreterm2","preterm", "preterm2",
                "sab_site", "tab_site","fetal_composite_outcome"), 

           labels = c("Hospitalization", "ICU admission", "Critical care", "Ventilation", "Pneumonia",  "Maternal death",
                      "Preganncy-related death", "Placental abruption", "Preterm labor", "Haemorrhage", "Embolic disease",
                      "Preeclampsia", "Eclampsia", "Preeclampsia or eclampsia" , "Any HDP ",
                      "HDP during or after COVID-19", "C-section", "Intrapartum C-section", "Maternal composite outcome",
               # fetal & neonatal morbidity & mortality outcomes:
                "Stillbirth site", "Stillbrith","Perinatal death", "Perinatal death site", 
               "Early neonatal death","Neonatal death", "NICU admission", 
               # Adverse Birth Outcomes
               "vLBW", "LBW", "eSGA","SGA", "vPTB", "vPTB - COVID onset <34w", "PTB", "PTB -COVID onset <37w",   
               "SAB site", "Tab site","Fetal composite outcome")))
  
 hmap <- heatmap_data2 %>% dplyr::filter(n_study>=1) %>%
    drop_na(Outcome) %>% # Removes NA estimates
    ggplot() +
    aes(x = Strain, y=Outcome, fill=RR_sig) +
    geom_tile(color="white", alpha=0.8)+
    scale_fill_manual(values = colScale) +
   # geom_text(aes(label=RR_CI_lab), size=2) + 
    guides(fill=guide_legend((title = "RR & 95%CI")))+
    labs(title=paste0("Reference strain: ",rs)) + 
    theme(plot.title = element_text(hjust = 0.5))
 
 day_string <- format(Sys.time(), "%Y%m%d")
 
 dir_folder_name <- paste0(day_string,"_dom_strain_",as.character(dom_threshold*100))
  dir.create(paste0("plots/heatmap/",dir_folder_name))
  
 ggsave(paste0("plots/heatmap/", dir_folder_name, "/variant_study_heatmap_refstrain_", rs, "_n_study>1.pdf"),
        hmap, width = 10, height = 6, units = "in")
}

```

##############
# END ABOVE #
#############

Heatmap - WORKS! 
```{r}
heatmap_draw_df <- read_excel('data/COVID-19_Alpha_ref_variant_outcomes_Pooled_est.xlsx', na="NA")#,
                         #col_types = c("text", "numeric", "numeric", "numeric", "numeric", 
                          #             "numeric", "numeric", "numeric", "numeric"))
# heatmap_df2 <- heatmap_df %>% dplyr::select(Outcome, Prealpha, Delta, Epsilon, Mixed)

# heatmap_long <- heatmap_df2 %>% pivot_longer(cols = c("Prealpha", "Delta", "Epsilon", "Mixed"), 
  #                                            names_to = "Strain",
    #                                          values_to = "RR")
outcome_vec = heatmap_draw_df$Outcome

heatmap_long <- heatmap_draw_df %>% 
  pivot_longer(-Outcome, 
               names_to = c("Strain", ".value"), 
               names_sep = "_")


heatmap_long2 <- heatmap_long %>% 
 # dplyr::mutate(RR = str_split(RRCI, pattern=fixed(" (")))
  #dplyr::mutate(RRCI_mod = gsub(pattern="[;()]"), replacement="", x=RRCI) %>%
  tidyr::separate(col=RRCI, sep=" ", into=c("RR", "LCI", "UCI"))

heatmap_long2$LCI <- gsub("[(]", "", heatmap_long2$LCI)
heatmap_long2$LCI <- gsub(";", "", heatmap_long2$LCI)
heatmap_long2$UCI <- gsub("[)]", "", heatmap_long2$UCI)

heatmap_long2 <- heatmap_long2 %>% 
  mutate(RR_CI_lab = paste0(RR, " (", LCI, ", ", UCI, "), n=", N)) %>%
  mutate(RR = as.numeric(RR), N=as.numeric(N)) %>%
  mutate(Strain = factor(Strain, levels = c("Prealpha", "Delta", "Epsilon", "Omicron", "Mixed"), ordered = TRUE)) %>%
  mutate(Outcome=factor(Outcome, levels = outcome_vec), ordered=TRUE)

heatmap_long2 <- heatmap_long2 %>% dplyr::filter(N>1)


heatmap_long2 %>% ggplot() +
  aes(x = Strain, y=Outcome, fill=RR) +
  geom_tile()+
  geom_text(aes(label=RR_CI_lab), size=2) + 
  scale_fill_gradient(low = "#FFFF69",
                    high = "#FD530A",
                    guide = "colorbar")


```

Heatmap: conditional formatting
```{r}
heatmap_long3 <- heatmap_long2 %>% 
  mutate(RR_sig = case_when((RR>1 & LCI>1 & UCI>1) ~ "RR>1, CI-sig",
                   (RR<1 & LCI <1 & UCI<1) ~ "RR<1, CI-sig",
                   ((RR>1|RR==1) & (LCI<1 | UCI<1)) ~ "RR>1, CI-notsig",
                   ((RR<1|RR==1) & (LCI<1 | UCI<1)) ~ "RR<1, CI-notsig"))

heatmap_long3$RR_sig <- factor(heatmap_long3$RR_sig, 
                               levels=c("RR>1, CI-sig", "RR<1, CI-sig", "RR>1, CI-notsig", "RR<1, CI-notsig"), 
                               ordered = TRUE)
```

Tile map/Heatmap with 4 categories. 
```{r}
library(RColorBrewer)
myColorScale <- brewer.pal(4,"Set2")
names(myColorScale) <- levels(heatmap_long3$RR_sig)
levels(heatmap_long3$RR_sig)


colScale <- c("RR>1, CI-sig" = "brown2", 
              "RR<1, CI-sig" = "aquamarine4", 
              "RR>1, CI-notsig"= "lightpink", 
              "RR<1, CI-notsig" = "aquamarine") 

heatmap_long3 %>% ggplot() +
  aes(x = Strain, y=Outcome, fill=RR_sig) +
  geom_tile()+
  scale_fill_manual(values = colScale) +
  geom_text(aes(label=RR_CI_lab), size=2) + 
  guides(fill=guide_legend((title = "RR & 95%CI")))

ggsave(filename = 'data_out/covid_variant_country_heatmap_20220919.pdf', width = 10, height = 6, units = "in")
```

########################################################
# DON'T NEED THIS BELOW CODE FOR NOW WITH THE IPD DATA # 
########################################################
USING *AGGREGATE* DATA: older file. 
```{r}
agd_df <- agd_long %>% dplyr::filter(grepl("calmonth", Strata)) # pulls out the rows that start with "calmonth" in the strata col. 
agd_df <- agd_df %>% separate(Strata, c("calmonth", "calmonth_date"), "_")
agd_df <- agd_df %>% mutate(date_ym = as.Date(paste0(substring(calmonth_date, 1,4), "-", substring(calmonth_date, 5), "-01"),
                                              format="%Y-%m-%d")) # substring pulls out the first 4 characters of the string first. 
agd_df <- agd_df %>% mutate(date_ym = format(date_ym, format = "%y-%m"))

agd_df <- rename(agd_df, site_id = "Site")
```

Merge the frequency dataset (wide) on our study dataset (Aggregate dataset)
```{r}
# country_id_agd <- agd_df %>% dplyr::select(site_id, Site_name) %>% distinct()
# write.csv(country_id_agd, 'data/country_id_agd.csv', row.names = FALSE) # I wrote this out and will update, so don't need this code.

agd_df2 <- left_join(agd_df, country_id_agd, by="site_id")
agd_df2 <- agd_df2 %>% dplyr::select(-Site_name.y)

agd_df3 <- left_join(agd_df2, df8_wide, by=c('country', 'date_ym'))
```

Summarize data
```{r}
#  "Events" column is actually the outcome and the "Total" is the denominator for that Strata
# So for example, if the Outcome is "Preterm Birth" and the Strata is "20203", then "Events" is the number of preterm births among livebirths with COVID-19 onset in March 2020, and "Total" is the total number of livebirths with COVID-19 onset in March 2020

#TODO calmonth_date has "m" that needs to be deleted - these are missing. We don't know what calmonth the outcome happened. 
table(agd_df3$Outcome)

agd_df3.1 <- agd_df3 %>% dplyr::filter(country==c("USA", "Canada", "Mexico", "Spain", "Hong Kong", "Italy", "Kenya"))
agd_df3.1 <- agd_df3.1 %>% dplyr::mutate(variant_mod = if_else(dominant_variant=="Pre_alpha", "Pre_alpha", "other_variant")) 
agd_df3.1$variant_mod <- factor(agd_df3.1$variant_mod, levels=c("other_variant", "Pre_alpha")) # factorized this variable
levels(agd_df3.1$variant_mod)

# wide dataset
agd_wide3.1 <- agd_df3.1 %>% pivot_wider(names_from = Outcome, values_from = Events)

agd_results <- agd_df3.1 %>% group_by(country, dominant_variant, Outcome) %>% summarize(count_condition=sum(Events),
                                                                       tot_n = sum(Total),
                                                                       incidence = count_condition/tot_n) %>% 
  ungroup()
# write.xlsx(as.data.frame(agd_results), file='data_out/variants_agd_results_20220610.xlsx', sheetName="dominant_strain", row.names = FALSE)

agd_results2 <- agd_df3.1 %>% group_by(country, variant_mod, Outcome) %>% summarize(count_condition=sum(Events),
                                                                       tot_n = sum(Total),
                                                                       incidence = count_condition/tot_n) 
# write.xlsx(as.data.frame(agd_results2), file='data_out/variants_agd_results_20220610.xlsx', sheetName="prealpha_vs.other", append=TRUE, row.names = FALSE)

```

```{r}
p1 <- agd_wide3.1 %>% 
  ggplot() +
  geom_histogram(aes(x=ICUadmit1/Total, fill=dominant_variant)) 

p2 <- agd_wide3.2 %>% 
  ggplot() +
  geom_histogram(aes(x=prdeath1/Total, fill=dominant_variant)) # maternal death

p3 <- agd_wide3.2 %>% 
  ggplot() +
  geom_histogram(aes(x=haemorrhage1/Total, fill=dominant_variant))

p4 <- agd_wide3.2 %>% 
  ggplot() +
  geom_histogram(aes(x=extremesga1/Total, fill=dominant_variant))

p5 <- agd_wide3.2 %>% 
  ggplot() +
  geom_histogram(aes(x=preterm1/Total, fill=dominant_variant))

p6 <- agd_wide3.2 %>% 
  ggplot() +
  geom_histogram(aes(x=c_intrap1/Total, fill=dominant_variant))

p1/p2/p3/p4/p5/p6


ggsave('data_out/variant_rates_20220610.pdf', plot=last_plot(), height = 13, width=4)
```

For modeling, using wide aggregated dataset. 
```{r}
summary(mod1 <- glm(preterm1 ~ variant_mod + country, family = "poisson", data=agd_wide3.2))

```


