---
title: "Vriant_Analysis"
author: "Fouzia Farooq"
date: "6/3/2022"
output: pdf_document
---
NOTE: This is FF's working copy (07/18/2022).

```{r, include=FALSE}
library(dplyr)
library(tidyr)
library(readr)
library(lubridate)
library(ggplot2)
library(RColorBrewer)
library(readxl)
library(xlsx)
library(patchwork)
library(haven)
library(meta)
# library(metafor)
# library(esc)
```

NOTES: json file was converted to csv in python (deepnote.com), then copied the code into BBtext and ran at the command line. 
Then ran the following code. 
Dates are fractions of a year after "year." We a creating a seperate dataframe into a csv that we will bring in R and use lubridate to read the date properly. 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


OPENSOURCE
```{r}
frequency <- read.csv('data/Nextstrain_opensource_frequenices.csv')
covid_opensource <- read.csv('data/nextstrain_ncov_open_global_all-time_metadata_20220517.csv')
pivots <- read.csv('data/Nextstrain_opensource_pivotdates.csv', header = FALSE)
# study_cases <- read_xlsx('data/variant_study_case_control_COVID_data_ff_20220524.xlsx') # case-comparison country study dates

# Study files
compiled_ipd_data_old <- read_dta('data/Compiled_IPD_Data_220217.dta') # old ipd data file
compiled_ipd_data_new <- read_dta('data/Compiled_IPD_Data_220620.dta') # updated with June 2022 data
# will take all the patient IDs from the new file and then add in the missing rows that are in the old file to this file. 
# agd_wide <- read_dta('data/Compiled_AGD_WIDE_220408.dta') # Has events, country, but no dates.
agd_long <- read_dta('data/Compiled_AGD_220408.dta') # Has events, country, but no dates.
country_id <- read.csv('data/country_id_ipd.csv') # FF created this file
# country_id_agd <- read.csv('data/country_id_agd.csv')
```

```{r}
table(compiled_ipd_data_old$site_id)
# sort(colnames(compiled_ipd_data_old))
```

```{r}
site_id_new <- compiled_ipd_data_new$site_id
compiled_ipd_data_old_2 <- compiled_ipd_data_old %>% dplyr::filter(!(site_id %in% site_id_new))
table(compiled_ipd_data_old_2$site_id)
class(compiled_ipd_data_new$neo_death_date3)
compiled_ipd_data_old_2$neo_death_date3 <- as.numeric(compiled_ipd_data_old_2$neo_death_date3)
compiled_ipd_data_old_2$neo_death_cause_77 <- as.numeric(compiled_ipd_data_old_2$neo_death_cause_77)
compiled_ipd_data_old_2$neo_death_cause2_77 <- as.numeric(compiled_ipd_data_old_2$neo_death_cause2_77)
compiled_ipd_data_old_2$neo_death_cause3_77 <- as.numeric(compiled_ipd_data_old_2$neo_death_cause3_77)
table(compiled_ipd_data_old_2$neo_death_date3, useNA = "always")
compiled_ipd_data <- full_join(compiled_ipd_data_old_2, compiled_ipd_data_new)
```

Drop twin and triplet rows that are 2nd/3rd.  Keep the woman though
```{r}
table(compiled_ipd_data$twin2, useNA = "always")
compiled_ipd_data <- compiled_ipd_data %>% dplyr::filter(twin2!=1 | tripletnum==0) # currently there are no triplets but there are some twins. 
table(compiled_ipd_data$tripletnum, useNA = "always")
```

```{r}
opensource.df <- covid_opensource %>% dplyr::select(strain, date, country, clade_membership)

opensource.df2 <- left_join(frequency, covid_opensource)

pivot_df <- data.frame(week = 0:(length(pivots$V1)-1), pivot = pivots$V1)
pivot_df <- pivot_df %>% dplyr::mutate(date = as.Date(date_decimal(pivot))) #converting the dates in decimal in nextstrain dataset to readable dates.

df <- left_join(opensource.df2, pivot_df, by="week")
```


```{r}
df2 <- df  %>% dplyr::mutate(variant = case_when(clade_membership %in% 
                                                   c("19A", "19B", "20A", "20B", "20C", "20D", "20F", "20G", "20E (EU1)") ~ "Pre_alpha",
                                                 clade_membership %in% 
                                                   c("20I (Alpha, V1)") ~ "Alpha",
                                                 clade_membership %in%
                                                   c("20H (Beta, V2)") ~ "Beta", 
                                                 clade_membership %in%
                                                   c("21B (Kappa)") ~ "Kappa", 
                                                 clade_membership %in%
                                                   c("21D (Eta)") ~ "Eta",
                                                 clade_membership %in% 
                                                   c("21E (Theta)") ~ "Theta",
                                                 clade_membership %in% 
                                                   c("20J (Gamma, V3)") ~ "Gamma",
                                                 clade_membership %in% 
                                                   c("21A (Delta)", "21I (Delta)", "21J (Delta)") ~ "Delta",
                                                 clade_membership %in% 
                                                   c("21C (Epsilon)") ~ "Epsilon",
                                                 clade_membership %in% 
                                                   c("21F (Iota)") ~ "Iota",
                                                 clade_membership %in% 
                                                   c("21G (Lambda)") ~ "Lambda",
                                                 clade_membership %in% 
                                                   c("21H (Mu)") ~ "Mu",
                                                 clade_membership %in% 
                                                   c("21K (Omicron)", "21L (Omicron)", "21M (Omicron)", "22C (Omicron)") ~ "Omicron"))

# table(df2$clade_membership, df2$variant, useNA = "always") # These all have a general variant name now. 

```

NORMALIZE FREQ BY COUNTRY
```{r}
df3 <- df2 %>% group_by(country, week, variant) %>% summarize(freq = sum(frequency))
df4 <- df3 %>% group_by(country, week) %>% 
  dplyr::mutate(nor = (freq/sum(freq))) %>%
  dplyr::filter(country %in% c("Kenya", "Uganda", "Spain", "Hong Kong", "Italy",
                               "South Africa", "USA", "Sweden", "Turkey", "China", "United Kingdom", 
                               "Chile", "Canada","Mexico", "Colombia", "USA", "India", "Africa", 
                               "Kenya", "Pakistan", "Bangladesh")) # List does not include DRC or Burkina Faso b/c opensource data is not available thorugh Nextstrain.  This list doesn't include all the african countries or the WHO countries. 

```




```{r}
df5 <- left_join(df4, pivot_df, by="week")

df6 <- df5 %>% dplyr::mutate(date_ym = format(date, format= "%y-%m"))
df7 <- df6 %>% group_by(country, date_ym) %>% dplyr::mutate(max_date = max(date))
df8 <- df7 %>% dplyr::filter(date == max_date)
# sort(colnames(compiled_ipd_data))
check.df <- compiled_ipd_data %>% dplyr::select(site_id, person_id, mat_age, preterm_labor)
```


<!-- Joining RFA dates only - NO NEED TO RUN FOR RFA ONLY (may need for CC): -->
<!-- ```{r} -->
<!-- study_cases$date <- mdy(study_cases$date) -->
<!-- cases <- study_cases %>% dplyr::mutate(date_ym = format(date,format="%y-%m")) -->
<!-- class(study_cases$date) -->

<!-- variants_cases <- left_join(df8, cases, by=c("country", "date_ym")) -->
<!-- ``` -->


************************
STARTING STUDY ANALYSIS:
************************
NOTE: The reason some of the RFA studies show up on covid_variant_country_20220717.pdf is b/c they have aggregate data but not ipd data.  on the 20220718 file, those have been removed (like the UK and Canada).  I am just plotting data from complied_ipd_data_old and compiled_ipd_data_new.  
```{r}
df9 <- left_join(compiled_ipd_data, country_id, by="site_id")
df10 <- df9 %>% dplyr::filter(site_id %in% c(1:21,2201,2202,23:38)) %>% 
  # Added 20, 24, 34, 37 and updated 5,17,10,19
  dplyr::select(site_id, city, country, site_name, mat_age, date_onset_or_test, covid_sympdate, covid_pos,
                               edd_date, fetuses, parity, gravidity, weight_pre, diab_prepreg, hyperten_prepreg, matdeath,
                              matdeath_date, covid_hosp, covid_icu, preeclampsia, eclampsia, pre_or_eclampsia, 
                              place_abrupt, preterm_labor, haemorrhage, hpd_any) 
# use date_onset_or_test --> If tested for covid, it is date of first positive test.  
#puerto rico, canada, mexico, madrid spain, hong kong, italy, kenya

check.df <- df9 %>% dplyr::select(site_id, mat_age, preterm_labor)

df10 <- df10 %>% dplyr::mutate(date_ym = format(date_onset_or_test,format="%y-%m"))
unique(df10$country)
unique(compiled_ipd_data$site_id)
unique(df10$site_name)
```

```{r}
## CREATEING A NEW FILE SO I CAN OVERLAY ON GRAPHS AGAIN TO SEE  IF WE HAVE  MORE THAN 1 VRIANT DATA WITH THIS UPDATED FILE FROM ERIN OR NOT.
check.df <- compiled_ipd_data_old %>% dplyr::select(site_id)
min(df10$date_onset_or_test, na.rm=TRUE)
df10.2 <- df10 %>% dplyr::select(site_id, city, country, site_name, date_onset_or_test, date_ym) 
check.df <- compiled_ipd_data_old %>% dplyr::filter(site_id=="1")
df10.2 <- df10.2 %>% dplyr::mutate(date_onset_or_test = format(date_onset_or_test,format="%m-%d-%y"))
df10.3 <- df10.2 %>% group_by(country) %>% arrange(country, date_ym)
df10.4 <- df10.3 %>% group_by(country, site_name, date_ym) %>% tally()
df10.4 <- df10.4 %>% rename(Events='n', site_name = "site_name") %>% mutate(study_type = "RFA",
                                                   Study_type_full = "Risk Factor Analysis")
df10.4 <- df10.4 %>% dplyr::filter(!is.na(date_ym))
df10.4 <- df10.4 %>% mutate(date = as.Date(paste0("20", date_ym, "-01")))
df10.5 <- df10.4 %>% mutate(pandemic_month = interval("2019-12-01", date) %/% months(1))

# df10.5$date <- format(df10.5$date, format="%y-%m-%d")
df10.6 <- df10.5 %>% dplyr::select(-date_ym)

# write.csv(df10.5, 'data/variant_newdata_dates_ipd_ff_20220627.csv', row.names = FALSE) # writing this file out so I can overlay on the graphs from nextstrain data
# study_cases_2 <- study_cases %>% dplyr::select(-study_period)   
study_cases_2 <- df10.6
# df10.7 <- rbind(study_cases_2, df10.6)
df10.8 <- df10.6 %>% arrange(country, study_type, date)
```

New map with overlayed CC study dates and RFA study dates: 06/27/2022 - latest
```{r}

studies_df <- df10.8 %>% dplyr::filter(Events>=1) %>% 
  group_by(country, site_name, study_type) %>%
  summarize(min_month = min(pandemic_month),
            max_month = max(pandemic_month)) %>%
  group_by(country) %>%
  mutate(country_study_number = 1:n(),
         country_total_studies = n())
# see https://stackoverflow.com/questions/36893957/dplyr-generate-row-number-row-position-in-group-by

gap_betw_studies <- 0.15


ggplot() +
  geom_bar(data = df8, stat="identity",
           mapping = aes(x = date_ym, fill = variant, y=nor)) +
  scale_fill_manual(values = c("Alpha" = "deepskyblue2", "Pre_alpha" = "lightsteelblue1", "Beta" = "darkseagreen1",
                               "Delta" = "gold", "Epsilon" = "burlywood", "Eta" = "cadetblue2", "Gamma" = "darkgoldenrod1",
                               "Iota" = "cyan3", "Lambda" = "gray70", "Mu" = "peachpuff1", "Omicron" = "plum2",
                               "Theta" = "tomato")) + 
  theme_light() + 
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust=1, size = 6),
        axis.text.y = element_text(size = 6)) + 
  xlab("Year-Month") + 
  ylab("Relative Frequency") +
  geom_rect(data = studies_df,
            mapping=aes(xmin=min_month-0.5,
                        xmax=max_month+0.5,
                        ymin= 0.5 - 0.5*gap_betw_studies*(country_total_studies-1) + gap_betw_studies*(country_study_number - 1) - 0.005,
                        ymax= 0.5 - 0.5*gap_betw_studies*(country_total_studies-1) + gap_betw_studies*(country_study_number - 1) + 0.005)) +
  geom_text(data = studies_df,
            mapping=aes(x = 0.5*(min_month + max_month),
                        y = 0.5 - 0.5*gap_betw_studies*(country_total_studies-1) + gap_betw_studies*(country_study_number - 1) + 0.05,
                        label = ifelse(is.na(site_name),
                                       study_type,
                                       paste(site_name, study_type))),
            size = 1.5) +
  guides(fill = guide_legend(override.aes = list(labels = c("A", "B")))) +
  facet_wrap(~country, nrow = 30, ncol = 1, scale = "free_x")

ggsave(filename = 'data_out/covid_variant_country_20220718.pdf', width = 6, height = 30, units = "in") # DON'T NEED TO WRITE THIS OUT EVERYTIME.

# write.csv(df8, 'data/nextstrain_frequency_data_written_ff_20220610.csv', row.names = FALSE)
```


Making frequency dataset wider and then we will join it onto compiled_ipd data
```{r}
df8.1 <- df8 %>% group_by(country, date_ym) %>%
  arrange(desc(freq)) %>% # we first ordered the frequency and the highest is on top. 
  mutate(dominant_variant = if_else(first(freq)==0,
                                    "no_strain", 
                                    # first(variant))) %>% 
                                      ifelse(!is.na(first(nor)) & first(nor)>=0.70, # This is the other way of defining the dominant variant-- when it's greater than 60% then call it the dominant variant, otherwise call the set mixed. 
                                           first(variant), 
                                           "mixed"))) %>% 
  mutate(dominant_variant_v1 = if_else(first(freq)==0,
                                    "no_strain", 
                                    first(variant))) %>%
  ungroup() %>%
  arrange(country, date_ym) # first arranges the strains in descending order then pulls out the strain name for the first one b/c now it has the greatest frequency. Then we ungrouped and rearranged so we can see by country and date order. 


df8_wide <- df8.1 %>% 
  dplyr::select(-c(freq, week, date, max_date, pivot)) %>% 
  pivot_wider(names_from = variant, values_from = nor, values_fill = 0, names_prefix = "freq_") # pivot wider and adds a prefix "freq" to the variable in "values_from".
# Pivot wider comes from tidyr.
```



Merge the frequency dataset (wide) on our study dataset (IPD dataset)
```{r}
df11 <- left_join(df10, df8_wide, by=c('country', 'date_ym'))
```

First pivot longer. (have a single column for the outcomes)
```{r}

df12 <- df11 %>% pivot_longer(cols = c(diab_prepreg, hyperten_prepreg, matdeath, covid_hosp, covid_icu,
                                       preeclampsia, eclampsia, pre_or_eclampsia, place_abrupt, preterm_labor,
                                       haemorrhage, hpd_any),
                              names_to = "outcome", values_to = "events")
# There are lots of "88" in the outcomes --> converting to NA
df12 <- df12 %>% mutate(events = if_else(events==88, as.numeric(NA), events))
df13 <- df12 %>% dplyr::filter(!is.na(events))
```

Groupby and summarize
```{r}
df14 <- df13 %>% group_by(site_name, country, dominant_variant, outcome) %>%
  summarize(events = sum(events, na.rm = FALSE),
            tot_n = n(),
            incidence = events/tot_n)

#write.xlsx(as.data.frame(df14), file='data_out/variants_ipd_results_20220706.xlsx', sheetName="dominant_strain_country", row.names = FALSE)

df14.1 <- df13 %>% group_by(dominant_variant, outcome) %>%
  summarize(events = sum(events, na.rm = FALSE),
            tot_n = n(),
            incidence = events/tot_n)

#write.xlsx(as.data.frame(df14.1), file='data_out/variants_ipd_results_20220706.xlsx', sheetName="dominant_strain_outcome", row.names = FALSE, append=TRUE)
```


```{r}
# This is more useful

df14 %>% 
  filter(dominant_variant!="Beta") %>% # beta numbers are very low. 
  ggplot() +
  geom_col(aes(x=dominant_variant, y=incidence, fill=outcome), 
           width = 0.65,
           position="dodge") + 
  scale_x_discrete(limits = c("no_strain", 'mixed', "Pre_alpha", "Alpha", "Beta", "Delta", "Omicron")) + 
  xlab("Dominant Strain")

df14.1 %>% 
  filter(dominant_variant!="Beta") %>% 
  ggplot() +
  geom_col(aes(x=outcome, y=incidence, fill= dominant_variant), 
           width = 0.7, 
           position="dodge") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r}
# Generates the wide format table with incidences of each outcome in each strain for each study site. 
df14.outcomes.wide <- df14 %>% 
  # dplyr::filter(!is.na(dominant_variant)) %>%
  pivot_wider(names_from = c(outcome), values_from = c(events, tot_n, incidence))
# write.csv(df14.outcomes.wide, file='data_out/VariantStudy_incidence_20220720.csv', na = "",row.names=FALSE)
```


Functions for continuity correction and calc logRR and SEs. 
```{r}
  ### used this link to calc: https://www.medcalc.org/manual/relative-risk-odds-ratio.php
  ### function for calculating RR (not logRR)
  rr_ff <- function(pos1, pos2, neg1, neg2, adj=0.5){
    useadj <- pos1==0 | neg1==0 | pos2==0 | neg2==0
    
    a <- pos1+useadj*adj
    b <- neg1+useadj*adj
    c <- pos2+useadj*adj
    d <- neg2+useadj*adj
    return((a/(a+b))/((c/(c+d))))
  }
  
  ### this calculates SE for logRR not just RR - so this is logSE
  se_logrr_ff <- function(pos1, pos2, neg1, neg2, adj=0.5){
    useadj <- pos1==0 | neg1==0 | pos2==0 | neg2==0
    a <- pos1+useadj*adj
    b <- neg1+useadj*adj
    c <- pos2+useadj*adj
    d <- neg2+useadj*adj
    return(sqrt((1/a)+(1/c)-(1/(a+b))-(1/(c+d))))
  }
```

Setting up for metagen:
```{r}
df14.negpos.outcome <- df14 %>% mutate(neg = tot_n - events)
strain_vec <- unique(df14.negpos.outcome$dominant_variant) # creates a vector of all different strain names.
strain_vec <- strain_vec[!is.na(strain_vec)] # removes NAs
strain_vec <- strain_vec[strain_vec!="no_strain"]
df14.alpha <- data.frame(matrix(nrow = 0, ncol=10))

for (ref.strain in strain_vec) {
  for (test.strain in strain_vec) {
    if(ref.strain==test.strain) {
      next # skips this iteration when the two strains are the same. 
    }
    df14.alpha.rows <- df14.negpos.outcome %>% 
      dplyr::filter(dominant_variant %in% c(ref.strain, test.strain)) %>%
      group_by(site_name, dominant_variant, outcome) %>%
      #  dplyr::filter(outcome %in% c("matdeath", "preterm_labor")) %>% 
      summarise(pos = sum(events), 
                neg = sum(neg)) %>%
      mutate(dominant_variant = if_else(dominant_variant==ref.strain,
                                        "reference",
                                        "test")) %>%
      pivot_wider(names_from = dominant_variant, values_from = c("pos", "neg")) %>%
      drop_na() %>% # drops countries that don't have one or the other dominant strain.
      mutate(ref.strain=ref.strain, test.strain=test.strain) %>%
       mutate(logRR = log(rr_ff(pos_reference, pos_test, neg_reference, neg_test)),
           logSE = se_logrr_ff(pos_reference, pos_test, neg_reference, neg_test))
    
    df14.alpha <- rbind(df14.alpha, df14.alpha.rows)
    
  }
}
```

*METAGEN FUNCTION*
```{r}
# FUNCTION CREATED:
metagen_fun <- function(refstr, teststr) {
  df14.strainpair <- df14.alpha %>%
    dplyr::filter(ref.strain==refstr &
                  test.strain==teststr)
  colnames(df14.strainpair)[colnames(df14.strainpair) == "pos_reference"] <- paste0(refstr, "+")
  colnames(df14.strainpair)[colnames(df14.strainpair) == "neg_reference"] <- paste0(refstr, "-")
  colnames(df14.strainpair)[colnames(df14.strainpair) == "pos_test"] <- paste0(teststr, "+")
  colnames(df14.strainpair)[colnames(df14.strainpair) == "neg_test"] <- paste0(teststr, "-")
    
  if(nrow(df14.strainpair)==0){ # when a certain pair of strains is not present, we wnat it to skip, e.g. Delta-Epsilon is missing when dominant strain defined as >=70% prevalence. 
    print("     No such strain pair found - better skip this one!")
    return()
  }

  #dplyr::rename(paste0(ref.str, "_pos") = "pos_reference")#, #+ or - symbols in names do not work
                  # paste0(teststr, "_pos") = "pos_test",
                  # paste0(refstr, "_neg") = "neg_reference",
                  # paste0(teststr, "_neg") = "neg_test")
  
  # Can we now use "dat" file that has the logRR and generate RR and SEs that we can feed into to metagen package. 
  # to="all" says add 1/2 to all the 2X2 cells (when events =0 for a set)
  
  
  ### metagen 
  mymeta <-metagen(logRR, logSE,
                   studlab=paste(site_name), data=df14.strainpair,
                   fixed= FALSE, random=TRUE,
                   subset=NULL, sm="RR",
                   method.tau="ML", # Default Restricted maximum likelihood estimator (REML) did not always converge so using ML. 
                   subgroup =df14.strainpair$outcome,
                   title="Variant")
# added in the continuity correction by hand - codded it. 
# manual process in STATA - replaced 0 with the inverse of the opposite arm. can try this code. Making the continuity correction smaller helps but not always. Pooled absolute risks and pooled relative risks that were illogical, absolute risk was high for one group but relative risk was lower for that group.   If there are 0 events for delta and alpha, what to do with that estimate. 
  # summary (mymeta)
  #generate forest plot:HERE
  pdf(file=paste0("plots/20220804_domvar_mixed_70/VariantStudy_MetaForestPlot_", refstr, "_", teststr, ".pdf"), width=10, height=22) # pdf saving has to go before making the plot and at the end have to say dev.off()
  
  forest(mymeta, sortvar=logRR, comb.random, 
         leftcols = c("studlab", paste0(teststr, "+"), paste0(teststr, "-"), paste0(refstr, "+"), paste0(refstr, "-")),
         colgap.forest.left = "1mm",
         fontsize = 10, 
         fs.hetstat = 9, 
         header=TRUE, 
         overall=FALSE, 
         col.diamond = "#33CC66", 
         col.study= "#333333" )
  # grid.text("Variant study by outcome", .5, .89, gp=gpar(cex=1)) # only works in R version 3.

  dev.off()
}
```

```{r}
for (ref.strain in strain_vec) {
  for (test.strain in strain_vec) {
    if(ref.strain==test.strain) {
      next # skips this iteration when the two strains are the same. 
    }
    print(paste(ref.strain, test.strain))
    metagen_fun(ref.strain, test.strain)
  }
}
```






########################################################
# DON'T NEED THIS BELOW CODE FOR NOW WITH THE IPD DATA # 
########################################################
USING *AGGREGATE* DATA: older file. 
```{r}
agd_df <- agd_long %>% dplyr::filter(grepl("calmonth", Strata)) # pulls out the rows that start with "calmonth" in the strata col. 
agd_df <- agd_df %>% separate(Strata, c("calmonth", "calmonth_date"), "_")
agd_df <- agd_df %>% mutate(date_ym = as.Date(paste0(substring(calmonth_date, 1,4), "-", substring(calmonth_date, 5), "-01"),
                                              format="%Y-%m-%d")) # substring pulls out the first 4 characters of the string first. 
agd_df <- agd_df %>% mutate(date_ym = format(date_ym, format = "%y-%m"))

agd_df <- rename(agd_df, site_id = "Site")
```

Merge the frequency dataset (wide) on our study dataset (Aggregate dataset)
```{r}
# country_id_agd <- agd_df %>% dplyr::select(site_id, Site_name) %>% distinct()
# write.csv(country_id_agd, 'data/country_id_agd.csv', row.names = FALSE) # I wrote this out and will update, so don't need this code.

agd_df2 <- left_join(agd_df, country_id_agd, by="site_id")
agd_df2 <- agd_df2 %>% dplyr::select(-Site_name.y)

agd_df3 <- left_join(agd_df2, df8_wide, by=c('country', 'date_ym'))
```

Summarize data
```{r}
#  "Events" column is actually the outcome and the "Total" is the denominator for that Strata
# So for example, if the Outcome is "Preterm Birth" and the Strata is "20203", then "Events" is the number of preterm births among livebirths with COVID-19 onset in March 2020, and "Total" is the total number of livebirths with COVID-19 onset in March 2020

#TODO calmonth_date has "m" that needs to be deleted - these are missing. We don't know what calmonth the outcome happened. 
table(agd_df3$Outcome)

agd_df3.1 <- agd_df3 %>% dplyr::filter(country==c("USA", "Canada", "Mexico", "Spain", "Hong Kong", "Italy", "Kenya"))
agd_df3.1 <- agd_df3.1 %>% dplyr::mutate(variant_mod = if_else(dominant_variant=="Pre_alpha", "Pre_alpha", "other_variant")) 
agd_df3.1$variant_mod <- factor(agd_df3.1$variant_mod, levels=c("other_variant", "Pre_alpha")) # factorized this variable
levels(agd_df3.1$variant_mod)

# wide dataset
agd_wide3.1 <- agd_df3.1 %>% pivot_wider(names_from = Outcome, values_from = Events)

agd_results <- agd_df3.1 %>% group_by(country, dominant_variant, Outcome) %>% summarize(count_condition=sum(Events),
                                                                       tot_n = sum(Total),
                                                                       incidence = count_condition/tot_n) %>% 
  ungroup()
# write.xlsx(as.data.frame(agd_results), file='data_out/variants_agd_results_20220610.xlsx', sheetName="dominant_strain", row.names = FALSE)

agd_results2 <- agd_df3.1 %>% group_by(country, variant_mod, Outcome) %>% summarize(count_condition=sum(Events),
                                                                       tot_n = sum(Total),
                                                                       incidence = count_condition/tot_n) 
# write.xlsx(as.data.frame(agd_results2), file='data_out/variants_agd_results_20220610.xlsx', sheetName="prealpha_vs.other", append=TRUE, row.names = FALSE)

```

```{r}
p1 <- agd_wide3.1 %>% 
  ggplot() +
  geom_histogram(aes(x=ICUadmit1/Total, fill=dominant_variant)) 

p2 <- agd_wide3.2 %>% 
  ggplot() +
  geom_histogram(aes(x=prdeath1/Total, fill=dominant_variant)) # maternal death

p3 <- agd_wide3.2 %>% 
  ggplot() +
  geom_histogram(aes(x=haemorrhage1/Total, fill=dominant_variant))

p4 <- agd_wide3.2 %>% 
  ggplot() +
  geom_histogram(aes(x=extremesga1/Total, fill=dominant_variant))

p5 <- agd_wide3.2 %>% 
  ggplot() +
  geom_histogram(aes(x=preterm1/Total, fill=dominant_variant))

p6 <- agd_wide3.2 %>% 
  ggplot() +
  geom_histogram(aes(x=c_intrap1/Total, fill=dominant_variant))

p1/p2/p3/p4/p5/p6


ggsave('data_out/variant_rates_20220610.pdf', plot=last_plot(), height = 13, width=4)
```

For modeling, using wide aggregated dataset. 
```{r}
summary(mod1 <- glm(preterm1 ~ variant_mod + country, family = "poisson", data=agd_wide3.2))

```


