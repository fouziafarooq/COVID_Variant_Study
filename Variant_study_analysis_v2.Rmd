---
title: "Variant_study_analysis_v2.Rmd"
author: "Fouzia Farooq"
date: "6/10/2022"
output: html_document
---
This file is for Jenny by FF.  Contains same code as "Variant_study_analyis_v1.Rmd"
Test push to github.
another push.
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(dplyr)
library(tidyr)
library(readr)
library(lubridate)
library(ggplot2)
library(RColorBrewer)
library(readxl)
library(xlsx)
library(patchwork)
library(haven)
library(meta)
library(metafor)
```

***************************************************
FILES FOR JENNY - matches v1 that FF is working on.
***************************************************

Read in the files:
```{r}
# Study files
# Study files
compiled_ipd_data_old <- read_dta('data/Compiled_IPD_Data_220217.dta') # old ipd data file
compiled_ipd_data_new <- read_dta('data/Compiled_IPD_Data_220620.dta') # updated with June 2022 data; IPD data doesn't have Canada, UK.
# agd_wide <- read_dta('data/Compiled_AGD_WIDE_220408.dta') # Has events, country, but no dates - aggregate data
agd_long <- read_dta('data/Compiled_AGD_220408.dta') # Has events, country, but no dates - aggregate data. 
country_id <- read.csv('data/country_id_ipd.csv') # created by FF
country_id_agd <- read.csv('data/country_id_agd.csv') # created by FF

# Nextstrain frequency file: 
df8 <- read.csv('data/nextstrain_frequency_data_written_ff_20220610.csv') # created by FF using nextstrain dataset.
# study_cases <- read_xlsx('data/variant_study_case_control_COVID_data_ff_20220524.xlsx') # this file isn't needed now.  This was just for making the figures of combined data from both aggregate files, case comparison studies and new ipd data. 

```

************************
STARTING STUDY ANALYSIS:
************************

```{r}
table(compiled_ipd_data_old$site_id)
# sort(colnames(compiled_ipd_data_old))
```

```{r}
site_id_new <- compiled_ipd_data_new$site_id
compiled_ipd_data_old_2 <- compiled_ipd_data_old %>% dplyr::filter(!(site_id %in% site_id_new))
table(compiled_ipd_data_old_2$site_id)
class(compiled_ipd_data_new$neo_death_date3)
compiled_ipd_data_old_2$neo_death_date3 <- as.numeric(compiled_ipd_data_old_2$neo_death_date3)
compiled_ipd_data_old_2$neo_death_cause_77 <- as.numeric(compiled_ipd_data_old_2$neo_death_cause_77)
compiled_ipd_data_old_2$neo_death_cause2_77 <- as.numeric(compiled_ipd_data_old_2$neo_death_cause2_77)
compiled_ipd_data_old_2$neo_death_cause3_77 <- as.numeric(compiled_ipd_data_old_2$neo_death_cause3_77)
table(compiled_ipd_data_old_2$neo_death_date3, useNA = "always")
compiled_ipd_data <- full_join(compiled_ipd_data_old_2, compiled_ipd_data_new)
```

Drop twin and triplet rows that are 2nd/3rd.  Keep the woman though
```{r}
table(compiled_ipd_data$twin2, useNA = "always")
compiled_ipd_data <- compiled_ipd_data %>% dplyr::filter(twin2!=1 | tripletnum==0) # currently there are no triplets but there are some twins. 
table(compiled_ipd_data$tripletnum, useNA = "always")
```

NOTE: The reason some of the RFA studies show up on covid_variant_country_20220717.pdf is b/c they have aggregate data but not ipd data.  on the 20220718 file, those have been removed (like the UK and Canada).  I am just plotting data from complied_ipd_data_old and compiled_ipd_data_new.  
```{r}
df9 <- left_join(compiled_ipd_data, country_id, by="site_id")
df10 <- df9 %>% dplyr::filter(site_id %in% c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,2201,2202,23,24,25,26,27,28,29,30,31,32,33,34,35,37,38)) %>% 
  # Added 20, 24, 34, 37 and updated 5,17,10,19
  dplyr::select(site_id, city, country, site_name, mat_age, date_onset_or_test, covid_sympdate, covid_pos,
                               edd_date, fetuses, parity, gravidity, weight_pre, diab_prepreg, hyperten_prepreg, matdeath,
                              matdeath_date, covid_hosp, covid_icu, preeclampsia, eclampsia, pre_or_eclampsia, 
                              place_abrupt, preterm_labor, haemorrhage, hpd_any) 
# use date_onset_or_test --> If tested for covid, it is date of first positive test.  
#puerto rico, canada, mexico, madrid spain, hong kong, italy, kenya

check.df <- df9 %>% dplyr::select(site_id, mat_age, preterm_labor)

df10 <- df10 %>% dplyr::mutate(date_ym = format(date_onset_or_test,format="%y-%m"))
unique(df10$country)
unique(compiled_ipd_data$site_id)
unique(df10$site_name)
```

```{r}
## CREATEING A NEW FILE SO I CAN OVERLAY ON GRAPHS AGAIN TO SEE  IF WE HAVE  MORE THAN 1 VRIANT DATA WITH THIS UPDATED FILE FROM ERIN OR NOT.
check.df <- compiled_ipd_data_old %>% dplyr::select(site_id)
min(df10$date_onset_or_test, na.rm=TRUE)
df10.2 <- df10 %>% dplyr::select(site_id, city, country, site_name, date_onset_or_test, date_ym) 
check.df <- compiled_ipd_data_old %>% dplyr::filter(site_id=="1")
df10.2 <- df10.2 %>% dplyr::mutate(date_onset_or_test = format(date_onset_or_test,format="%m-%d-%y"))
df10.3 <- df10.2 %>% group_by(country) %>% arrange(country, date_ym)
df10.4 <- df10.3 %>% group_by(country, site_name, date_ym) %>% tally()
df10.4 <- df10.4 %>% rename(Events='n', site_name = "site_name") %>% mutate(study_type = "RFA",
                                                   Study_type_full = "Risk Factor Analysis")
df10.4 <- df10.4 %>% dplyr::filter(!is.na(date_ym))
df10.4 <- df10.4 %>% mutate(date = as.Date(paste0("20", date_ym, "-01")))
df10.5 <- df10.4 %>% mutate(pandemic_month = interval("2019-12-01", date) %/% months(1))

# df10.5$date <- format(df10.5$date, format="%y-%m-%d")
df10.6 <- df10.5 %>% dplyr::select(-date_ym)

# write.csv(df10.5, 'data/variant_newdata_dates_ipd_ff_20220627.csv', row.names = FALSE) # writing this file out so I can overlay on the graphs from nextstrain data
# study_cases_2 <- study_cases %>% dplyr::select(-study_period)   
study_cases_2 <- df10.6
# df10.7 <- rbind(study_cases_2, df10.6)
df10.8 <- df10.6 %>% arrange(country, study_type, date)
```

New map with overlayed CC study dates and RFA study dates: 06/27/2022 - latest
```{r}

studies_df <- df10.8 %>% dplyr::filter(Events>=1) %>% 
  group_by(country, site_name, study_type) %>%
  summarize(min_month = min(pandemic_month),
            max_month = max(pandemic_month)) %>%
  group_by(country) %>%
  mutate(country_study_number = 1:n(),
         country_total_studies = n())
# see https://stackoverflow.com/questions/36893957/dplyr-generate-row-number-row-position-in-group-by

gap_betw_studies <- 0.15


ggplot() +
  geom_bar(data = df8, stat="identity",
           mapping = aes(x = date_ym, fill = variant, y=nor)) +
  scale_fill_manual(values = c("Alpha" = "deepskyblue2", "Pre_alpha" = "lightsteelblue1", "Beta" = "darkseagreen1",
                               "Delta" = "gold", "Epsilon" = "burlywood", "Eta" = "cadetblue2", "Gamma" = "darkgoldenrod1",
                               "Iota" = "cyan3", "Lambda" = "gray70", "Mu" = "peachpuff1", "Omicron" = "plum2",
                               "Theta" = "tomato")) + 
  theme_light() + 
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust=1, size = 6),
        axis.text.y = element_text(size = 6)) + 
  xlab("Year-Month") + 
  ylab("Relative Frequency") +
  geom_rect(data = studies_df,
            mapping=aes(xmin=min_month-0.5,
                        xmax=max_month+0.5,
                        ymin= 0.5 - 0.5*gap_betw_studies*(country_total_studies-1) + gap_betw_studies*(country_study_number - 1) - 0.005,
                        ymax= 0.5 - 0.5*gap_betw_studies*(country_total_studies-1) + gap_betw_studies*(country_study_number - 1) + 0.005)) +
  geom_text(data = studies_df,
            mapping=aes(x = 0.5*(min_month + max_month),
                        y = 0.5 - 0.5*gap_betw_studies*(country_total_studies-1) + gap_betw_studies*(country_study_number - 1) + 0.05,
                        label = ifelse(is.na(site_name),
                                       study_type,
                                       paste(site_name, study_type))),
            size = 1.5) +
  guides(fill = guide_legend(override.aes = list(labels = c("A", "B")))) +
  facet_wrap(~country, nrow = 30, ncol = 1, scale = "free_x")

ggsave(filename = 'data_out/covid_variant_country_20220718.pdf', width = 6, height = 30, units = "in") # DON'T NEED TO WRITE THIS OUT EVERYTIME.

# write.csv(df8, 'data/nextstrain_frequency_data_written_ff_20220610.csv', row.names = FALSE)
```


Making frequency dataset wider and then we will join it onto compiled_ipd data
```{r}
df8.1 <- df8 %>% group_by(country, date_ym) %>%
  arrange(desc(freq)) %>% 
  mutate(dominant_variant = if_else(first(freq)==0,
                                    "no_strain", 
                                    first(variant))) %>% 
  ungroup() %>%
  arrange(country, date_ym) # first arranges the strains in descending order then pulls out the strain name for the first one b/c now it has the greatest frequency. Then we ungrouped and rearranged so we can see by country and date order. 
  

df8_wide <- df8.1 %>% 
  dplyr::select(-c(freq, week, date, max_date, pivot)) %>% 
  pivot_wider(names_from = variant, values_from = nor, values_fill = 0, names_prefix = "freq_") # pivot wider and adds a prefix "freq" to the variable in "values_from".
# Pivot wider comes from tidyr.
```

Merge the frequency dataset (wide) on our study dataset (IPD dataset)
```{r}
df11 <- left_join(df10, df8_wide, by=c('country', 'date_ym'))
```

First pivot longer. (have a single column for the outcomes)
```{r}

df12 <- df11 %>% pivot_longer(cols = c(diab_prepreg, hyperten_prepreg, matdeath, covid_hosp, covid_icu,
                                       preeclampsia, eclampsia, pre_or_eclampsia, place_abrupt, preterm_labor,
                                       haemorrhage, hpd_any),
                              names_to = "outcome", values_to = "events")
# There are lots of "88" in the outcomes --> converting to NA
df12 <- df12 %>% mutate(events = if_else(events==88, as.numeric(NA), events))
df13 <- df12 %>% dplyr::filter(!is.na(events))
```

Groupby and summarize
```{r}
df14 <- df13 %>% group_by(site_name, country, dominant_variant, outcome) %>%
  summarize(events = sum(events, na.rm = FALSE),
            tot_n = n(),
            incidence = events/tot_n)

#write.xlsx(as.data.frame(df14), file='data_out/variants_ipd_results_20220706.xlsx', sheetName="dominant_strain_country", row.names = FALSE)

df14.1 <- df13 %>% group_by(dominant_variant, outcome) %>%
  summarize(events = sum(events, na.rm = FALSE),
            tot_n = n(),
            incidence = events/tot_n)

#write.xlsx(as.data.frame(df14.1), file='data_out/variants_ipd_results_20220706.xlsx', sheetName="dominant_strain_outcome", row.names = FALSE, append=TRUE)
```

```{r}
# This is more useful

df14 %>% 
  filter(dominant_variant!="Beta") %>% # beta numbers are very low. 
  ggplot() +
  geom_col(aes(x=dominant_variant, y=incidence, fill=outcome), 
           width = 0.65,
           position="dodge") + 
  scale_x_discrete(limits = c("no_strain", "Pre_alpha", "Alpha", "Beta", "Delta", "Omicron")) + 
  xlab("Dominant Strain")

df14.1 %>% 
  filter(dominant_variant!="Beta") %>% 
  ggplot() +
  geom_col(aes(x=outcome, y=incidence, fill= dominant_variant), 
           width = 0.7, 
           position="dodge") + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r}
# Generates the wide format table with incidences of each outcome in each strain for each study site. 
df14.outcomes.wide <- df14 %>% 
  # dplyr::filter(!is.na(dominant_variant)) %>%
  pivot_wider(names_from = c(outcome), values_from = c(events, tot_n, incidence))
# write.csv(df14.outcomes.wide, file='data_out/VariantStudy_incidence_20220720.csv', na = "",row.names=FALSE)
```

***META ANALYSIS WITH IPD DATA***
I first should filter data to pre_alpha and alpha, pre_alpha and delta, pre_alpha and omicron etc. Run seperate analyses on each set then(?) Need to ask e about this. 

```{r}

# outcomes: heamorrhage, diab_prepreg, preterm_labor, pre_or_eclampsia, eclampsia, covid_icu
# Reshaping data
meta_fun <- function(outcome.var, strain.var, strain.var2) {
  
  df14.negpos.outcome <- df14 %>% mutate(neg = tot_n - events)
  df14.alpha <- df14.negpos.outcome %>% 
    dplyr::filter(dominant_variant %in% c("Pre_alpha", strain.var)) %>%
    group_by(site_name, dominant_variant, outcome) %>%
    dplyr::filter(outcome==outcome.var) %>% 
    summarise(pos = sum(events), 
              neg = sum(neg)) %>%
    mutate(dominant_variant = if_else(dominant_variant=="Pre_alpha",
                                      "Pre_alpha",
                                      "treatment_strain")) %>%
    pivot_wider(names_from = dominant_variant, values_from = c("pos", "neg")) %>%
    drop_na() # drops countries that don't have one or the other dominant strain.
  
  dat <- escalc(measure="RR", ai=pos_treatment_strain, bi=neg_treatment_strain, ci=pos_Pre_alpha, di=neg_Pre_alpha, data=df14.alpha,
                slab=paste(site_name), add=1/2) # calculates log relative risk (?) and it's variances. 
  #TODO Add 0.5 to the other set of events also when adding where events = 0.
  
  ### fit random-effects model
  #res <- rma.glmm(yi, vi, data=dat)
  res <- rma(yi, vi, data=dat)
  res
 #  write.csv(dat, file='data_out/VarinatStudy_MetaTable.csv')
  pdf(file=paste0('plots/VariantStudy_MetaForestPlot.', strain.var, '.', outcome.var, '.pdf'))
  
  ### forest plot with extra annotations
  forest(res, atransf=exp, at=log(c(.05, .25, 1, 4)), xlim=c(-16,6),
         ilab=cbind(pos_treatment_strain, neg_treatment_strain, pos_Pre_alpha, neg_Pre_alpha),
         ilab.xpos=c(-9.5,-8,-6,-4.5), 
         cex=.75, 
         header=paste0("Site name          ", "outcome: ", outcome.var, ".     ",strain.var, " (+/-) vs. Prealpha (+-)      ", mlab=""))
         op <- par(cex=.75, font=2) 
         #cex=.75, header="Site name", mlab="")
         

  #text(c(-9.5,-8,-6,-4.5), 15, c(paste0(strain.var, "+"), paste0(strain.var, "-"), "Prealpha+", "Prealpha-"))
  #text(c(-8.75,-5.25),     16, c("Dominant", "Reference"))
  text(x=c(-9.5,-8,-6,-4.5), y=15, c("+", "-", "+", "-"))
  text(x=c(-8.75,-5.25),     y=16, c("Dominant", "Reference"))
  #text(x =  30, y = 16, "Dataset",  pos=4)
  #text(x = 165, y = 16, "Accuracy", pos = 2, font = 4)
  par(op)
  
  ### add text with Q-value, dfs, p-value, and I^2 statistic
  text(-16, -1, pos=4, cex=0.75, bquote(paste("RE Model (Q = ",
                                              .(formatC(res$QE, digits=2, format="f")), ", df = ", .(res$k - res$p),
                                              ", p = ", .(formatC(res$QEp, digits=2, format="f")), "; ", I^2, " = ",
                                              .(formatC(res$I2, digits=1, format="f")), "%)")))
  
  dev.off()

  }
#TODO Ask emily: unbalanced groups when we group over months for different strains.  i.e. prealpha period was say 6 months but omicron was only 3 months. 

```

```{r}
# outcomes: haemorrhage, diab_prepreg, preterm_labor, pre_or_eclampsia, covid_icu, covid_hosp, matdeath, place_abrupt, hpd_any, hyperten_prepreg
meta.fun.call <- meta_fun(outcome.var = "preterm_labor", strain.var = "Alpha")
```
