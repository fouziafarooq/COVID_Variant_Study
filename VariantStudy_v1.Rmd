---
title: "COVID-19_VariantStudy_v1"
author: "Fouzia Farooq"
date: "5/11/2022"
output: pdf_document
---

```{r}
library(dplyr)
library(readr)
library(lubridate)
library(ggplot2)
library(RColorBrewer)
```

NOTES: json file was converted to csv in python (deepnote.com), then copied the code into BBtext and ran at the command line. 
Then ran the following code. 
Dates are fractions of a year after "year." We a creating a seperate dataframe into a csv that we will bring in R and use lubridate to read the date properly. 
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<!-- ```{r} -->
<!-- usa <- read_delim('data/nextstrain_ncov_open_global_all-time_metadata.tsv', col_types = cols(date = col_date("%m/%d/%y"), -->
<!--                                                                                              division = "f")) -->
<!-- covid.data <- read_delim('data/nextstrain_ncov_gisaid_global_all-time_metadata.tsv', col_types = cols(date = col_date("%Y-%m-%d"))) -->
<!-- ``` -->


<!-- ```{r} -->
<!-- table(covid.data$country) -->
<!-- usa <- covid.data %>% dplyr::filter(country=="USA") %>% dplyr::filter(date>=as.Date("2021-04-29") & date<=as.Date("2021-05-05")) -->
<!-- table(usa$date) -->
<!-- prop.table(table(usa$Nextstrain_clade)) -->
<!-- table(usa$clade_membership, usa$variant, useNA = "always") -->
<!-- usa <- usa %>% dplyr::mutate(variant = case_when(clade_membership %in% c("19A", "19B", "20A", "20B", "20C", "20G") ~ "Pre_alpha", -->
<!--                                                  clade_membership %in% c("20I (Alpha, V1)") ~ "Alpha", -->
<!--                                                  clade_membership %in% c("20J (Gamma, V3)") ~ "Gamma", -->
<!--                                                  clade_membership %in% c("21A (Delta)", "21I (Delta)", "21J (Delta)") ~ "Delta", -->
<!--                                                  clade_membership %in% c("21C (Epsilon)") ~ "Epsilon", -->
<!--                                                  clade_membership %in% c("21F (Iota)") ~ "Iota", -->
<!--                                                  clade_membership %in% c("21G (Lambda)") ~ "Lambda", -->
<!--                                                  clade_membership %in% c("21H (Mu)") ~ "Mu", -->
<!--                                                  clade_membership %in% c("21K (Omicron)", "21L (Omicron)", "22C (Omicron)") ~ "Omicron")) -->

<!-- ``` -->

GISAID: 
```{r}
frequency <- read.csv('data/Nextstrain_frequenices.csv')
gisaid <- read.csv('data/metadata_gisaid_20220516.csv')
pivots <- read.csv('data/Nextstrain_pivotdates.csv', header = FALSE)
study_cases <- read.csv('data/casesbymonth_220329_ff.csv', header = TRUE, na.strings = "")
gisaid.df <- gisaid %>% dplyr::select(strain, date, country, clade_membership)

gisaid.df2 <- left_join(frequency, gisaid.df)

clade.freq.week <- gisaid.df2 %>% group_by(country, week, clade_membership) %>% summarize(freq = sum(frequency))

pivot_df <- data.frame(week = 0:(length(pivots$V1)-1), pivot = pivots$V1)
pivot_df <- pivot_df %>% dplyr::mutate(date = as.Date(date_decimal(pivot)))

gisaid_clade <- left_join(clade.freq.week, pivot_df)
```

Study cases data: 
```{r}
  cases <- study_cases %>% dplyr::mutate(year = as.integer(substring(Strata, 10, 13)),
                      month = as.integer(substring(Strata, 14,15)))
  cases <- cases %>% dplyr::mutate(pandemic_month = month + (year-2020)*12)
```

OPENSOURCE
```{r}
frequency <- read.csv('data/Nextstrain_opensource_frequenices.csv')
covid_opensource <- read.csv('data/nextstrain_ncov_open_global_all-time_metadata_20220517.csv')
pivots <- read.csv('data/Nextstrain_opensource_pivotdates.csv', header = FALSE)
```

```{r}
opensource.df <- covid_opensource %>% dplyr::select(strain, date, country, clade_membership)

opensource.df2 <- left_join(frequency, covid_opensource)


pivot_df <- data.frame(week = 0:(length(pivots$V1)-1), pivot = pivots$V1)
pivot_df <- pivot_df %>% dplyr::mutate(date = as.Date(date_decimal(pivot)))

df <- left_join(opensource.df2, pivot_df, by="week")
```


```{r}
df2 <- df  %>% dplyr::mutate(variant = case_when(clade_membership %in% 
                                                   c("19A", "19B", "20A", "20B", "20C", "20D", "20F", "20G", "20E (EU1)") ~ "Pre_alpha",
                                                 clade_membership %in% 
                                                   c("20I (Alpha, V1)") ~ "Alpha",
                                                 clade_membership %in%
                                                   c("20H (Beta, V2)") ~ "Beta", 
                                                 clade_membership %in%
                                                   c("21B (Kappa)") ~ "Kappa", 
                                                 clade_membership %in%
                                                   c("21D (Eta)") ~ "Eta",
                                                 clade_membership %in% 
                                                   c("21E (Theta)") ~ "Theta",
                                                 clade_membership %in% 
                                                   c("20J (Gamma, V3)") ~ "Gamma",
                                                 clade_membership %in% 
                                                   c("21A (Delta)", "21I (Delta)", "21J (Delta)") ~ "Delta",
                                                 clade_membership %in% 
                                                   c("21C (Epsilon)") ~ "Epsilon",
                                                 clade_membership %in% 
                                                   c("21F (Iota)") ~ "Iota",
                                                 clade_membership %in% 
                                                   c("21G (Lambda)") ~ "Lambda",
                                                 clade_membership %in% 
                                                   c("21H (Mu)") ~ "Mu",
                                                 clade_membership %in% 
                                                   c("21K (Omicron)", "21L (Omicron)", "21M (Omicron)", "22C (Omicron)") ~ "Omicron"))

table(df2$clade_membership, df2$variant, useNA = "always") # These all have a general variant name now. 

```

NORMALIZE FREQ BY COUNTRY
```{r}
df3 <- df2 %>% group_by(country, week, variant) %>% summarize(freq = sum(frequency))
df4 <- df3 %>% group_by(country, week) %>% 
  dplyr::mutate(nor = (freq/sum(freq))) %>%
  dplyr::filter(country %in% c("Kenya", "Uganda", "Spain", "Hong Kong", "Italy", "Ghana", "Nigeria",
                               "South Africa", "USA", "Sweden", "Turkey", "Argentina", "Brazil",
                               "Philippines", "Pakistan", "Tunisia")) # List does not include DRC or Burkina Faso b/c opensource data is not available thorugh Nextstrain.

```


<!-- ```{r} -->
<!-- # this is global data - it matches the nextstrain viz.  -->
<!-- clade.freq.week <- opensource.df2 %>% group_by(week, clade_membership) %>% summarize(freq = sum(frequency)) -->
<!-- opensource.df3 <- left_join(clade.freq.week, pivot_df, by="week") -->
<!-- ``` -->




```{r}
df5 <- left_join(df4, pivot_df, by="week")

df6 <- df5 %>% dplyr::mutate(date_ym = format(date, format= "%y-%m"))
df7 <- df6 %>% group_by(country, date_ym) %>% dplyr::mutate(max_date = max(date))
df8 <- df7 %>% dplyr::filter(date == max_date)
```

Joining on the study cases data
```{r}
cases2 <- cases %>% dplyr::select(Events, country=Country, year, month, pandemic_month) %>% 
  dplyr::mutate(date_ym = paste0(as.character(year-2000), "-", sprintf("%02d", month)))

variants_cases <- left_join(df8, cases2, by=c("country", "date_ym"))
```

```{r}
fill_colors <- factor(1,2)
palette1 <- c("#999999", "000000")
variants_cases %>% ggplot() +
  geom_bar(stat="identity",
           mapping = aes(x = date_ym, fill = variant, y=nor)) +
  scale_fill_manual(values = c("Alpha" = "deepskyblue2", "Pre_alpha" = "gray70", "Beta" = "darkseagreen1",
                               "Delta" = "gold", "Epsilon" = "burlywood", "Eta" = "cadetblue2", "Gamma" = "darkgoldenrod1",
                               "Iota" = "cyan3", "Lambda" = "lightsteelblue1", "Mu" = "peachpuff1", "Omicron" = "plum2",
                               "Theta" = "tomato", "present" = rgb(0,0,0, alpha=0.5), "absent" = rgb(0,0,0,alpha = 0))) + 
  theme(axis.text.x = element_text(angle=90, vjust = 0.5, hjust=1, size = 8)) + 
  geom_rect(mapping=aes(xmin=pandemic_month-1,
                        xmax=pandemic_month,
                        ymin=0.48,
                        ymax=0.52,
                        fill = ifelse(Events>0, "present", "absent"))) +
  facet_wrap(~country, nrow = 16, ncol = 1, scale = "free_x")


   
ggsave(filename = 'data_out/covid_variant_country.pdf', width = 6, height = 25, units = "in")
  
```



